<!DOCTYPE html>
<html>
  <head>
    <script src="js/curl.js"></script>
    <script src="js/slycat-curl-config.js"></script>
    <script src="js/jquery-2.1.1.min.js"></script>
    <script src="js/knockout-3.2.0.js"></script>
    <style>
      .cell
      {
        font-size: 10px;
      }
    </style>
    <title>Slycat Grid Test</title>
  </head>
  <body>
    <div class="grid-viewport" data-bind="style: {width: viewport_width() + 'px', height: viewport_height() + 'px'}, event: {scroll: on_scroll}" style="overflow: auto;">
      <div class="grid" data-bind="style: {width: width() + 'px', height: height() + 'px'}, foreach: cells()", style="position: relative">
        <div class="cell" data-bind="html: content, style: {top: top + 'px', height: height + 'px', left: left + 'px', width: width + 'px'}" style="position: absolute;">
        </div>
      </div>
    </div>
    <p>Grid Shape: <span data-bind="text: row_count"></span> rows x <span data-bind="text: column_count"></span> columns</p>
    <p>Grid Dimensions: <span data-bind="text: width"></span> x <span data-bind="text: height"></span></p>
    <p>Offset: <span data-bind="text: position()[0]"></span> x <span data-bind="text: position()[1]"></span></p>
    <p>Visible Rows: <span data-bind="text: visible_cells().row_begin"></span> : <span data-bind="text:visible_cells().row_end"></span></p>
    <p>Visible Columns: <span data-bind="text: visible_cells().column_begin"></span> : <span data-bind="text:visible_cells().column_end"></span></p>
    <p>Total Cells: <span data-bind="text: cells().length"></span></p>
    <script>
      require(["knockout"], function(ko)
      {
        var grid =
        {
          row_count: ko.observable(1600000),
          column_count: ko.observable(400000),
          cell_width: ko.observable(75),
          cell_height: ko.observable(20),
          viewport_width: ko.observable(500),
          viewport_height: ko.observable(500),
          position: ko.observable([0, 0]).extend({rateLimit: {timeout: 100, method: "notifyWhenChangesStop"}}),
        };
        grid.height = ko.pureComputed(function()
        {
          return grid.row_count() * grid.cell_height();
        });
        grid.width = ko.pureComputed(function()
        {
          return grid.column_count() * grid.cell_width();
        });
        grid.visible_cells = ko.pureComputed(function()
        {
          var position = grid.position();
          var cell_width = grid.cell_width();
          var cell_height = grid.cell_height();
          var viewport_width = grid.viewport_width();
          var viewport_height = grid.viewport_height();
          var row_count = grid.row_count();
          var column_count = grid.column_count();

          return {
            column_begin: Math.floor(position[0] / cell_width),
            column_end: Math.min(column_count, Math.ceil((position[0] + viewport_width) / cell_width)),
            row_begin: Math.floor(position[1] / cell_height),
            row_end: Math.min(row_count, Math.ceil((position[1] + viewport_height) / cell_height)),
          }
        });
        grid.cells = ko.pureComputed(function()
        {
          var visible_cells = grid.visible_cells();
          var cell_width = grid.cell_width();
          var cell_height = grid.cell_height();

          console.log("cells", visible_cells);

          var cells = [];
          for(var row = visible_cells.row_begin; row != visible_cells.row_end; ++row)
          {
            for(var column = visible_cells.column_begin; column != visible_cells.column_end; ++column)
            {
              cells.push(
              {
                top: row * cell_height,
                height: cell_height,
                left: column * cell_width,
                width: cell_width,
                content: grid.create_cell(row, column),
              });
            }
          }
          return cells;
        });
        grid.on_scroll = function(grid, event)
        {
          grid.position([$(".grid-viewport").scrollLeft(), $(".grid-viewport").scrollTop()]);
        }
        grid.create_cell = function(row, column)
        {
          return "<span>" + row + "," + column + "</span>";
        }

        ko.applyBindings(grid);
      });
    </script>
  </body>
</html>
