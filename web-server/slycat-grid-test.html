<!DOCTYPE html>
<html>
  <head>
    <script src="js/curl.js"></script>
    <script src="js/slycat-curl-config.js"></script>
    <script src="js/jquery-2.1.1.min.js"></script>
    <script src="js/knockout-3.2.0.js"></script>
    <style>
      .cell
      {
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <div class="grid-viewport" data-bind="style: {width: viewport_width() + 'px', height: viewport_height() + 'px'}, event: {scroll: on_scroll}" style="overflow: auto;">
      <div class="grid" data-bind="style: {width: width() + 'px', height: height() + 'px'}, foreach: cells()", style="position: relative">
        <div class="cell" data-bind="style: {top: top + 'px', height: height + 'px', left: left + 'px', width: width + 'px'}" style="position: absolute;">
          <span data-bind="text:content"></span>
        </div>
      </div>
    </div>
    <p>Grid Shape: <span data-bind="text: row_count"></span> rows x <span data-bind="text: column_count"></span> columns</p>
    <p>Grid Dimensions: <span data-bind="text: width"></span> x <span data-bind="text: height"></span></p>
    <p>Offset: <span data-bind="text: position()[0]"></span> x <span data-bind="text: position()[1]"></span></p>
    <p>Visible Rows: <span data-bind="text: row_begin"></span> : <span data-bind="text: row_end"></span></p>
    <p>Visible Columns: <span data-bind="text: column_begin"></span> : <span data-bind="text: column_end"></span></p>
    <script>
      require(["knockout"], function(ko)
      {
        var grid =
        {
          row_count: ko.observable(100),
          column_count: ko.observable(100),
          cell_width: ko.observable(50),
          cell_height: ko.observable(15),
          viewport_width: ko.observable(500),
          viewport_height: ko.observable(500),
          position: ko.observable([0, 0]).extend({rateLimit: 500}),
        };
        grid.height = ko.pureComputed(function()
        {
          return grid.row_count() * grid.cell_height();
        });
        grid.width = ko.pureComputed(function()
        {
          return grid.column_count() * grid.cell_width();
        });
        grid.column_begin = ko.pureComputed(function()
        {
          return Math.floor(grid.position()[0] / grid.cell_width());
        });
        grid.column_end = ko.pureComputed(function()
        {
          return Math.min(grid.column_count(), Math.ceil((grid.position()[0] + grid.viewport_width()) / grid.cell_width()));
        });
        grid.row_begin = ko.pureComputed(function()
        {
          return Math.floor(grid.position()[1] / grid.cell_height());
        });
        grid.row_end = ko.pureComputed(function()
        {
          return Math.min(grid.row_count(), Math.ceil((grid.position()[1] + grid.viewport_height()) / grid.cell_height()));
        });
        grid.cells = ko.pureComputed(function()
        {
          var row_begin = grid.row_begin();
          var row_end = grid.row_end();
          var column_begin = grid.column_begin();
          var column_end = grid.column_end();
          var cell_width = grid.cell_width();
          var cell_height = grid.cell_height();

          console.log("cells", row_begin, row_end, column_begin, column_end);

          var cells = [];
          for(var row = row_begin; row != row_end; ++row)
          {
            for(var column = column_begin; column != column_end; ++column)
            {
              cells.push(
              {
                top: row * cell_height,
                height: cell_height,
                left: column * cell_width,
                width: cell_width,
                content: row + ", " + column,
              });
            }
          }
          return cells;
        });
        grid.on_scroll = function(grid, event)
        {
          grid.position([$(".grid-viewport").scrollLeft(), $(".grid-viewport").scrollTop()]);
        }

        ko.applyBindings(grid);
      });
    </script>
  </body>
</html>
