$(document).ready(function() {

  var bookmarker = new bookmark_manager("{{server-root}}", "{{#full-project}}{{_id}}{{/full-project}}", "{{_id}}");
  var bookmark = null;

  function show_status_messages() {
console.log("Inside show_status_messages()");
    $("#status-messages").dialog({
      autoOpen: true,
      width: 500,
      height: 300,
      modal: false,
      buttons:
      {
        OK: function()
        {
          $("#status-messages").dialog("close");
        }
      }
    });
  }

  function artifact_missing() {
console.log("Inside artifact_missing()");
    $(".load-status").css("display", "none");

    $("#status-messages").empty().html(
      "<div class='error-heading'>Oops, there was a problem retrieving data from the model.</div>" +
      "<div class='error-description'>This probably means that there was a problem building the model. " +
      "Here's the last thing that was going on with it:</div>" +
      "<pre>" + model["message"] + "</pre>");

    show_status_messages();
  }

  function Controls(plot) {
    this.ready = false;
    this.plot = plot;
  };

  function Layout() {
console.log("Setup layout");
  };

  function Model() {
console.log("Setup model");
    this.model = null;
    this.metadata = null;
    this.indices = null;
    this.input_columns = null;
    this.output_columns = null;
    this.image_columns = null;
    this.rating_columns = null;
    this.category_columns = null;
  };

  function Table() {
console.log("Setup table");
    this.statistics = null;
    this.ready = false;
  };

  function ScatterPlot(plot_ref) {
console.log("Setup scatter plot");
    this.plot_ref = "#" + plot_ref;  // DOM plot ref
    this.controls = null;

    this.x_index = null;
    this.y_index = null;
    this.v_index = null;
    this.images_index = null;
    this.x = null;
    this.y = null;
    this.v = null;
    this.images = null;
    this.selected_simulations = null;
    this.hidden_simulations = null;

    this.ready = false;
    this.controls_ready = false;

    this.session_cache = {};
    this.image_uri = document.createElement("a");
  }

  Model.prototype.load = function() {
console.log("LOAD THE MODEL 1 -- ajax");
    var self = this;
    $.ajax(
    {
      type : "GET",
      url : "{{server-root}}models/{{_id}}",
      success : function(result)
      {
        self.model = result;
        self.input_columns = self.model["artifact:input-columns"];
        self.output_columns = self.model["artifact:output-columns"];
        self.image_columns = self.model["artifact:image-columns"];
        self.rating_columns = self.model["artifact:rating-columns"] == undefined ? [] : self.model["artifact:rating-columns"];
        self.category_columns = self.model["artifact:category-columns"] == undefined ? [] : self.model["artifact:category-columns"];
        self.loaded();
      },
      error: function(request, status, reason_phrase)
      {
        window.alert("Error retrieving model: " + reason_phrase);
      }
    });
  };

  Model.prototype.get_numeric_variables = function() {
    var numeric_variables = [];
    for(var i = 0; i < model.metadata["column-count"]-1; i++)
    {
      // only use non-string columns that are not used for ratings or categories
      if(model.metadata["column-types"][i] != 'string' && model.rating_columns.indexOf(i) == -1 && model.category_columns.indexOf(i) == -1)
        numeric_variables.push(i);
    }
    return numeric_variables;
  };

  ScatterPlot.prototype.setup_labels = function() {
    // choose some columns for the x and y axes.
    var numeric_variables = model.get_numeric_variables();
    this.x_index = numeric_variables[0];
    this.y_index = numeric_variables[1 % numeric_variables.length]; // use 0 if only one element, use 1 otherwise
    if("x-selection" in bookmark)
      this.x_index = Number(bookmark["x-selection"]);
    if("y-selection" in bookmark)
      this.y_index = Number(bookmark["y-selection"]);
  };

  ScatterPlot.prototype.setup_simulations = function() {
    // set state of selected and hidden simulations
    this.selected_simulations = [];
    if("simulation-selection" in bookmark)
      this.selected_simulations = bookmark["simulation-selection"];
    this.hidden_simulations = [];
    if("hidden-simulations" in bookmark)
      this.hidden_simulations = bookmark["hidden-simulations"];
  };

  //////////////////////////////////////////////////////////////////////////////////////////
  // Once the model has been loaded, retrieve metadata / bookmarked state
  //////////////////////////////////////////////////////////////////////////////////////////

  Model.prototype.loaded = function() {
    var self = this;
console.log("Inside model_loaded()");
    if(self.model["state"] == "waiting" || self.model["state"] == "running")
    {
      $("#status-messages").empty().html(
        "<div class='error-heading'>Oops, this model isn't ready yet.</div>" +
        "<div class='error-description'>We're probabably building it for you right now." +
        "Watch the status bar for progress information and more details.</div>");
      show_status_messages();
    }
    else if(self.model["state"] == "closed" && self.model["result"] === null)
    {
      $("#status-messages").empty().html(
        "<div class='error-heading'>Oops, it looks like this model was never completed.</div>" +
        "<div class='error-description'>Here's the last thing that was happening before it was closed:</div>" +
        "<pre>" + model["message"] + "</pre>");
      show_status_messages();
    }
    else if(self.model["result"] == "failed")
    {
      $("#status-messages").empty().html(
        "<div class='error-heading'>Oops, it looks like this model failed to build.</div>" +
        "<div class='error-description'>Here's what was happening when it ended:</div>" +
        "<pre>" + model["message"] + "</pre>");
      show_status_messages();
    }
    else
    {
      // Display progress as the load happens ...
      $(".load-status").text("Loading data.");

      // Mark this model as closed, so it doesn't show-up in the header anymore.
console.log("mark this model as closed -- ajax");
      $.ajax(
      {
        type : "PUT",
        url : "{{server-root}}models/{{_id}}",
        contentType : "application/json",
        data : $.toJSON({
          "state" : "closed"
        }),
        processData : false
      });

console.log("Inside model laoded - load table metadata 1 -- ajax");
      // Load data table metadata.
      $.ajax({
        url : "{{server-root}}models/{{_id}}/tables/data-table/arrays/0/metadata?index=Index",
        contentType : "application/json",
        success: function(metadata)
        {
          self.metadata = metadata;
          table.statistics = new Array(metadata["column-count"]);
          table.statistics[metadata["column-count"]-1] = {"max": metadata["row-count"]-1, "min": 0};
console.log("about to call metadata_loaded ....");
console.log("context is : ");
console.log(self);
          //debugger;
          table.load_statistics(d3.range(self.metadata["column-count"]-1), self.metadata_loaded, self);
        },
        error: artifact_missing
      });

      // TODO integrate into callbacks
      // Retrieve bookmarked state information ...
      bookmarker.get_state(function(state)
      {
        bookmark = state;
        layout.setup_colorswitcher();
        //debugger;
        //self.metadata_loaded();
      });
    }
  };


  //////////////////////////////////////////////////////////////////////////////////////////
  // Setup page layout and forms.
  //////////////////////////////////////////////////////////////////////////////////////////

  // Setup the edit model form ...
  Layout.prototype.setup = function() {
console.log("setting up the layout");
    $("#edit-model-form").dialog(
    {
      autoOpen: false,
      width: 700,
      height: 300,
      modal: true,
      buttons:
      {
        "Save Changes": function()
        {
          var model =
          {
            "name" : $("#edit-model-name").val(),
            "description" : $("#edit-model-description").val()
          };

console.log("save model changes -- ajax");
          $.ajax(
          {
            type : "PUT",
            url : "{{server-root}}models/{{_id}}",
            contentType : "application/json",
            data : $.toJSON(model),
            processData : false,
            success : function()
            {
              window.location.reload();
            },
            error : function(request, status, reason_phrase)
            {
              window.alert("Error updating model: " + reason_phrase);
            }
          });
        },
        Cancel: function()
        {
          $(this).dialog("close");
        }
      },
      close: function()
      {
      }
    });

    $("#delete-model-link").click(function(){
      if(!window.confirm("Delete model {{name}}?  This cannot be undone."))
        return false;

  console.log("delete model -- ajax");
      $.ajax(
      {
        type : "DELETE",
        url : "{{server-root}}models/{{_id}}",
        success : function(details)
        {
          window.location.href = "{{server-root}}projects/{{#full-project}}{{_id}}{{/full-project}}";
        },
        error : function(request, status, reason_phrase)
        {
          window.alert("Error deleting model: " + reason_phrase);
        }
      });
    });

    $("#edit-model-button").button().click(function()
    {
      $("#edit-model-form").dialog("open");
      $("#edit-model-name").focus();
    });


    // Layout resizable panels ...
    $("body").layout(
    {
      north:
      {
      },
      center:
      {
      },
      south:
      {
        size: $("body").height() / 2,
        resizeWhileDragging: false,
        onresize: function() {
          $("#table").css("height", $("#table-pane").height());
          $("#table").table("resize_canvas");
        }
      },
    });

    $("#model-pane").layout(
    {
      center:
      {
        resizeWhileDragging: false,
        onresize: function() {
          scatterplots.each(function(plot) {
            resize.call(plot);
          });
        },
      }
    });
  };

  ScatterPlot.prototype.resize = function() {
    $(this.plot_ref + " .scatterplot").scatterplot("option", {
      width: $(this.plot_ref + ".scatterplot-pane").width(),
      height: $(this.plot_ref + ".scatterplot-pane").height()
    });
  };

  //////////////////////////////////////////////////////////////////////////////////////////
  // setup the rest of the ui as data is received.
  //////////////////////////////////////////////////////////////////////////////////////////

  Layout.prototype.setup_colorswitcher = function() {
console.log("inside setup_colorswitcher()");
    var self = this;
    var colormap = bookmark["colormap"] !== undefined ? bookmark["colormap"] : "night";

    $("#color-switcher").colorswitcher({colormap:colormap});
    $("#color-switcher").bind("colormap-changed", function(event, colormap)
    {
      self.selected_colormap_changed(colormap);
    });
  };

  ScatterPlot.prototype.update_axis = function(index, axis) {
    var self = this;
    get_model_array_attribute({
      server_root : "{{server-root}}",
      mid : "{{_id}}",
      aid : "data-table",
      array : 0,
      attribute : index,
      success : function(result)
      {
        self[axis] = result;
        self.setup();
        // TODO refactor to setup the table ONCE after all ajax requests// table.setup();
      },
      error : artifact_missing
    });
  };

Model.prototype.metadata_loaded = function() {
console.log("inside metadata loaded()");
console.log(this);

  if(!this.indices && this.metadata) {
    var count = this.metadata["row-count"];
    this.indices = new Int32Array(count);
    for(var i = 0; i != count; ++i)
      this.indices[i] = i;
  }

  if(this.metadata && bookmark) {
    scatterplots.forEach(function(plot) {
      plot.setup_labels();
      plot.setup_simulations();

      plot.update_axis(plot.x_index, "x");
      plot.update_axis(plot.y_index, "y");

      plot.v_index = model.metadata["column-count"] - 1;
      if("variable-selection" in bookmark)
        plot.v_index = Number(bookmark["variable-selection"]);

      if(plot.v_index == model.metadata["column-count"] - 1)
      {
        var count = model.metadata["row-count"];
        plot.v = new Float64Array(count);
        for(var i = 0; i != count; ++i)
          plot.v[i] = i;
        plot.setup();
      }
      else
      {
        plot.update_axis(plot.v_index, "v");
      }

      plot.images_index = model.image_columns[0];
      if("images-selection" in bookmark) {
        plot.images_index = bookmark["images-selection"];
      }
      table.setup();
      console.log("GET models/id/arraysets/data-table/arrays/0/attrs -- ajax");
      $.ajax({
        type : "GET",
        url : "{{server-root}}models/{{_id}}/arraysets/data-table/arrays/0/attributes/"
          + plot.images_index + "/chunk?ranges=0," + model.metadata["row-count"],
        success : function(result)
        {
          plot.images = result;
          // TODO set this up after all ajax requests are done -- plot.setup();
          // TODO set this up after all ajax requests are done -- this.setup();
        },
        error: artifact_missing
      });
      plot.controls.setup();
    });
    table.setup(); //TODO: decouple this from scatterplot - currently dependent
  }
};

  Table.prototype.setup = function() {
console.log("inside TABLE setup()");
    // TODO what do we do here with the x and y index ??
    // TODO - for now using the first plot
    // TODO - can this be decoupled?
    // this means we are still good for parameter image
    debugger;
    var plot = scatterplots[0];
    var x_index = plot.x_index;
    var y_index = plot.y_index;
    var v_index = plot.v_index;
    var images_index = plot.images_index;
    var selected_simulations = plot.selected_simulations;
    var hidden_simulations = plot.hidden_simulations;
    if( !this.ready && model.metadata && (this.statistics.length == model.metadata["column-count"])
      && bookmark && (x_index != null) && (y_index != null) && (images_index != null)
      && (selected_simulations != null) && (hidden_simulations != null) )
    {
      this.ready = true;

      $("#table-pane .load-status").css("display", "none");

      var other_columns = [];
      for(var i = 0; i != model.metadata["column-count"] - 1; ++i)
      {
        if($.inArray(i, model.input_columns) == -1 && $.inArray(i, model.output_columns) == -1
          && $.inArray(i, model.rating_columns) == -1 && $.inArray(i, model.category_columns) == -1)
          other_columns.push(i);
      }

      var table_options =
      {
        "server-root" : "{{server-root}}",
        mid : "{{_id}}",
        aid : "data-table",
        metadata : model.metadata,
        statistics : table.statistics,
        inputs : model.input_columns,
        outputs : model.output_columns,
        others : other_columns,
        images : model.image_columns,
        ratings : model.rating_columns,
        categories : model.category_columns,
        "image-variable" : images_index,
        "x-variable" : x_index,
        "y-variable" : y_index,
        "row-selection" : selected_simulations,
        hidden_simulations : hidden_simulations
      };

      var colormap = bookmark["colormap"] !== undefined ? bookmark["colormap"] : "night";
      table_options.colormap = $("#color-switcher").colorswitcher("get_color_map", colormap);

      if("sort-variable" in bookmark && "sort-order" in bookmark)
      {
        table_options["sort-variable"] = bookmark["sort-variable"];
        table_options["sort-order"] = bookmark["sort-order"];
      }

      if("variable-selection" in bookmark)
      {
        table_options["variable-selection"] = [bookmark["variable-selection"]];
      }
      else
      {
        table_options["variable-selection"] = [model.metadata["column-count"] - 1];
      }

      $("#table").table(table_options);

      // Log changes to the table sort order ...
      $("#table").bind("variable-sort-changed", function(event, variable, order)
      {
        this.variable_sort_changed(variable, order);
      });

      // Log changes to the x variable ...
      $("#table").bind("x-selection-changed", function(event, variable)
      {
        plot.x_selection_changed(variable);
      });

      // Log changes to the y variable ...
      $("#table").bind("y-selection-changed", function(event, variable)
      {
        plot.y_selection_changed(variable);
      });

      // Log changes to the images variable ...
      $("#table").bind("images-selection-changed", function(event, variable)
      {
        plot.images_selection_changed(variable);
      });

      // Log changes to the table variable selection ...
      // column selection in table
      $("#table").bind("variable-selection-changed", function(event, selection)
      {
        plot.selected_variable_changed(selection[0]);
      });

      // Log changes to the table row selection ...
      $("#table").bind("row-selection-changed", function(event, selection)
      {
        // The table selection is an array buffer which can't be
        // serialized as JSON, so convert it to an array.
        var temp = [];
        for(var i = 0; i != selection.length; ++i)
          temp.push(selection[i]);
        plot.selected_simulations_changed(temp);
        $(plot.plot_ref + " .scatterplot").scatterplot("option", "selection",  temp);
        $(plot.plot_ref + " .controls").controls("option", "selection",  temp);
      });

      // Changing the colormap updates the table ...
      $("#color-switcher").bind("colormap-changed", function(event, colormap)
      {
        $("#table").table("option", "colormap", $("#color-switcher").colorswitcher("get_color_map", colormap));
      });

      // Changing the table variable updates the scatterplot ...
      $("#table").bind("variable-selection-changed", function(event, selection)
      {
        plot.update_value(selection[0]);
      });

      // Changing the scatterplot selection updates the table row selection and controls ..
      $(".scatterplot").bind("selection-changed", function(event, selection)
      {
        $("#table").table("option", "row-selection", selection);
        $(plot.plot_ref + " .controls").controls("option", "selection", selection);
      });

      // Changing the x variable updates the table ...
      $(plot.plot_ref + " .controls").bind("x-selection-changed", function(event, variable)
      {
        $("#table").table("option", "x-variable", variable);
      });

      // Changing the y variable updates the table ...
      $(plot.plot_ref + " .controls").bind("y-selection-changed", function(event, variable)
      {
        $("#table").table("option", "y-variable", variable);
      });

      // Changing the image variable updates the table ...
      $(plot.plot_ref + " .controls").bind("images-selection-changed", function(event, variable)
      {
        $("#table").table("option", "image-variable", variable);
      });

      // Changing the color variable updates the table ...
      $(plot.plot_ref + " .controls").bind("color-selection-changed", function(event, variable)
      {
        $("#table").table("option", "variable-selection", [Number(variable)]);
      });
    }
  };

  ScatterPlot.prototype.setup = function() {
console.log("inside PLOT setup()");
    // Setup the scatterplot ...
    if(!this.ready && bookmark && model.indices && this.x && this.y && this.v && this.images
      && (this.selected_simulations != null) && (this.hidden_simulations != null))
    {
      var self = this;
      this.ready = true;

      $(this.plot_ref + " .scatterplot-pane .load-status").hide();

      var colormap = bookmark["colormap"] !== undefined ? bookmark["colormap"] : "night";

      $(this.plot_ref + " .scatterplot-pane").css("background", $("#color-switcher").colorswitcher("get_background", colormap).toString());

      var open_images = [];
      if("open-images-selection" in bookmark)
        open_images = bookmark["open-images-selection"];

      //Get the first parent that has a defined size, and fill it
      //TODO: Adjust this, the size should likely be calculated based on siblings
      var sized_parent = $("#grid-pane");

      $(this.plot_ref + " .scatterplot").scatterplot({
        indices: model.indices,
        x_label: model.metadata["column-names"][self.x_index],
        y_label: model.metadata["column-names"][self.y_index],
        v_label: model.metadata["column-names"][self.v_index],
        x: self.x,
        y: self.y,
        v: self.v,
        images: self.images,
        width: sized_parent.width(),
        height: sized_parent.height() / $(".scatterplot").length,
        color: $("#color-switcher").colorswitcher("get_color_map", colormap),
        selection: self.selected_simulations,
        server_root: "{{server-root}}",
        open_images: open_images,
        gradient: $("#color-switcher").colorswitcher("get_gradient_data", colormap),
        hidden_simulations: self.hidden_simulations
      });

      $(self.plot_ref + " .scatterplot").bind("selection-changed", function(event, selection) {
        self.selected_simulations_changed(selection);
      });

      // Changing the color map updates the scatterplot ...
      $("#color-switcher").bind("colormap-changed", function(event, colormap)
      {
        $(self.plot_ref + " .scatterplot-pane").css("background", $("#color-switcher").colorswitcher("get_background", colormap).toString());
        $(self.plot_ref + " .scatterplot").scatterplot("option", {
          color:    $("#color-switcher").colorswitcher("get_color_map", colormap),
          gradient: $("#color-switcher").colorswitcher("get_gradient_data", colormap),
        });
      });

      // Changing the x variable updates the scatterplot ...
      $("#table").bind("x-selection-changed", function(event, variable)
      {
        self.update_x(variable);
      });
      $(this.plot_ref + " .controls").bind("x-selection-changed", function(event, variable)
      {
        self.update_x(variable);
      });

      // Changing the y variable updates the scatterplot ...
      $("#table").bind("y-selection-changed", function(event, variable)
      {
        self.update_y(variable);
      });
      $(this.plot_ref + " .controls").bind("y-selection-changed", function(event, variable)
      {
        self.update_y(variable);
      });

      // Changing the images variable updates the scatterplot ...
      $("#table").bind("images-selection-changed", function(event, variable)
      {
console.log("changing the images var updates the scatter plot -- ajax");
        $.ajax(
        {
          type : "GET",
          url : "{{server-root}}models/{{_id}}/arraysets/data-table/arrays/0/attributes/" +
            variable + "/chunk?ranges=0," + model.metadata["row-count"],
          success : function(result)
          {
            $(self.plot_ref + " .scatterplot").scatterplot("option", "images", result);
          },
          error: artifact_missing
        });
      });
      $(this.plot_ref + " .controls").bind("images-selection-changed", function(event, variable)
      {
console.log("GET models/id/attrs / image selection changed -- ajax");
        $.ajax(
        {
          type : "GET",
          url : "{{server-root}}models/{{_id}}/arraysets/data-table/arrays/0/attributes/" +
            variable + "/chunk?ranges=0," + model.metadata["row-count"],
          success : function(result)
          {
            $(self.plot_ref + " .scatterplot").scatterplot("option", "images", result);
          },
          error: artifact_missing
        });
      });

      // Log changes to open images ...
      $(self.plot_ref + " .scatterplot").bind("open-images-changed", function(event, selection)
      {
        self.open_images_changed(selection);
      });
    }
  };

  Controls.prototype.setup = function() {
console.log("inside setup_controls()");
    var plot = this.plot;
    if( !this.ready && model.metadata && (model.image_columns != null) && (model.rating_columns != null)
      && (model.category_columns != null) && (plot.x_index != null) && (plot.y_index != null)
      && (plot.images_index != null) && (plot.selected_simulations != null) )
    {
      this.ready = true;
      var numeric_variables = [];

      for(var i = 0; i < model.metadata["column-count"]; i++)
      {
        if(model.metadata["column-types"][i] != 'string')
          numeric_variables.push(i);
      }

      var color_variable = model.metadata["column-count"] - 1;
      if("variable-selection" in bookmark)
      {
        color_variable = [bookmark["variable-selection"]];
      }

      $(plot.plot_ref + " .controls").controls({
        "server-root" : "{{server-root}}",
        mid : "{{_id}}",
        model_name: "{{name}}",
        aid : "data-table",
        metadata: model.metadata,
        x_variables: numeric_variables.slice(0, numeric_variables.length-1),
        y_variables: numeric_variables.slice(0, numeric_variables.length-1),
        image_variables: model.image_columns,
        color_variables: [numeric_variables[numeric_variables.length-1]].concat(numeric_variables.slice(0, numeric_variables.length-1)),
        rating_variables : model.rating_columns,
        category_variables : model.category_columns,
        selection : plot.selected_simulations,
        "x-variable" : plot.x_index,
        "y-variable" : plot.y_index,
        "image-variable" : plot.images_index,
        "color-variable" : color_variable
      });

      // Changing the x variable updates the controls ...
      $("#table").bind("x-selection-changed", function(event, variable)
      {
        $(plot.plot_ref + " .controls").controls("option", "x-variable", variable);
      });

      // Changing the y variable updates the controls ...
      $("#table").bind("y-selection-changed", function(event, variable)
      {
        $(plot.plot_ref + " .controls").controls("option", "y-variable", variable);
      });

      // Changing the image variable updates the controls ...
      $("#table").bind("images-selection-changed", function(event, variable)
      {
        $(plot.plot_ref + " .controls").controls("option", "image-variable", variable);
      });

      // Changing the table variable updates the controls ...
      $("#table").bind("variable-selection-changed", function(event, selection)
      {
        $(plot.plot_ref + " .controls").controls("option", "color-variable", selection[0]);
      });

      // Changing the table variable updates the legend label ...
      $("#table").bind("variable-selection-changed", function(event, selection)
      {
        $(plot.plot_ref + " .scatterplot").scatterplot("option", {v_label:model.metadata["column-names"][selection[0]]});
      });

      // Changing the color variable updates the scatterplot ...
      $(plot.plot_ref + " .controls").bind("color-selection-changed", function(event, variable)
      {
        plot.update_value(variable);
      });

      // Changing the color variable updates the legend label ...
      $(plot.plot_ref + " .controls").bind("color-selection-changed", function(event, variable)
      {
        $(plot.plot_ref + " .scatterplot").scatterplot("option", {v_label:model.metadata["column-names"][variable]});
      });

      // Changing the value of a variable updates the database, table, and scatterplot ...
      $(plot.plot_ref + " .controls").bind("set-value", function(event, arguments)
      {
        //console.log("set-value. selection: " + selection + ", variable: " + variable + ", value: " + value);
        var selection = arguments.selection;
        var variable = arguments.variable;
        var myBlob = new Blob(['[' + arguments.value + ']'], {type: "text/html"});

        var hyperslice = "";
        writeData(selection, variable, myBlob, 0);

        function writeData(selection, variable, blob, iterator){
console.log("inside writeData()");
          hyperslice = selection[iterator] + ":" + (selection[iterator]+1);
          var formdata = new FormData();
          // formdata.append("array", 0);
          // formdata.append("attribute", variable);
          // formdata.append("hyperslice", hyperslice);
          formdata.append("hyperchunks", 0 + "/" + variable + "/" + hyperslice);
          formdata.append("data", blob);
console.log("write data PUT models/id/arraysets/data-table/data -- ajax");
          $.ajax({
            type: "PUT",
            url : "{{server-root}}models/{{_id}}/arraysets/data-table/data",
            data : formdata,
            processData: false,
            contentType: false,
            success : function(results)
            {
              console.log("writing array data SUCCESS");
              iterator++;
              if(iterator<selection.length) {
                writeData(selection, variable, blob, iterator);
              }
              else {
                // Finished writing data, need to update widgets

                $("#table").table("update_data");

                if(variable == this.x_index)
                  plot.update_x(variable);
                if(variable == y_index)
                  plot.update_y(variable);
                if(variable == v_index)
                  plot.update_value(variable);

                table.load_statistics([variable], function(){
                  $("#table").table("option", "statistics", table.statistics);
                });
              }

            },
            error : function(jqXHR, textStatus, errorThrown)
            {
              console.log("writing array data error");
            },
          });
        }

      });

      // Log changes to the x variable ...
      $(plot.plot_ref + " .controls").bind("x-selection-changed", function(event, variable)
      {
        plot.x_selection_changed(variable);
      });

      // Log changes to the y variable ...
      $(plot.plot_ref + " .controls").bind("y-selection-changed", function(event, variable)
      {
        plot.y_selection_changed(variable);
      });

      // Log changes to the images variable ...
      $(plot.plot_ref + " .controls").bind("images-selection-changed", function(event, variable)
      {
        plot.images_selection_changed(variable);
      });

      // Log changes to the color variable ...
      $(plot.plot_ref + " .controls").bind("color-selection-changed", function(event, variable)
      {
        plot.selected_variable_changed(Number(variable));
      });

      // Log changes to hidden selection ...
      $(plot.plot_ref + " .controls").bind("hide-selection", function(event, selection)
      {
        for(var i=0; i<plot.selected_simulations.length; i++){
          if($.inArray(plot.selected_simulations[i], plot.hidden_simulations) == -1) {
            plot.hidden_simulations.push(plot.selected_simulations[i]);
          }
        }
        hidden_simulations_changed();
        $("#table").table("option", "hidden_simulations", plot.hidden_simulations);
        $(plot.plot_ref + " .scatterplot").scatterplot("option", "hidden_simulations", plot.hidden_simulations);
      });

      // Log changes to hidden selection ...
      $(plot.plot_ref + " .controls").bind("show-selection", function(event, selection)
      {
        for(var i=0; i<plot.selected_simulations.length; i++){
          var index = $.inArray(plot.selected_simulations[i], plot.hidden_simulations);
          if(index != -1) {
            plot.hidden_simulations.splice(index, 1);
          }
        }
        plot.hidden_simulations_changed();
        $("#table").table("option", "hidden_simulations", plot.hidden_simulations);
        $(plot.plot_ref + " .scatterplot").scatterplot("option", "hidden_simulations", plot.hidden_simulations);
      });
    }
  };

  //////////////////////////////////////////////////////////////////////////////////////////
  // Event handlers.
  //////////////////////////////////////////////////////////////////////////////////////////

  Layout.prototype.selected_colormap_changed = function(colormap) {
console.log("inside selected_colormap_changed()");
console.log("colormap change POST events/models/id/ -- ajax");
    $.ajax(
    {
      type : "POST",
      url : "{{server-root}}events/models/{{_id}}/select/colormap/" + colormap
    });
    bookmarker.updateState({"colormap" : colormap});
  };

  ScatterPlot.prototype.selected_variable_changed = function(variable) {
console.log("inside selected_variable_chagned()");
console.log("selected variable changed -- ajax");
    $.ajax(
    {
      type : "POST",
      url : "{{server-root}}events/models/{{_id}}/select/variable/" + variable
    });
    bookmarker.updateState({"variable-selection" : variable});
    this.v_index = Number(variable);
  };

  Table.prototype.variable_sort_changed = function(variable, order) {
console.log("inside variable sort changed");
console.log("variable sort changed -- ajax");
    $.ajax(
    {
      type : "POST",
      url : "{{server-root}}events/models/{{_id}}/select/sort-order/" + variable + "/" + order
    });
    bookmarker.updateState( {"sort-variable" : variable, "sort-order" : order} );
  };

  ScatterPlot.prototype.selected_simulations_changed = function(selection) {
console.log("inside selected simulations changed");
    // Logging every selected item is too slow, so just log the count instead.
console.log("selectred sim changed changed -- ajax");
    $.ajax(
    {
      type : "POST",
      url : "{{server-root}}events/models/{{_id}}/select/simulation/count/" + selection.length
    });
    bookmarker.updateState( {"simulation-selection" : selection} );
    this.selected_simulations = selection;
  };

  ScatterPlot.prototype.x_selection_changed = function(variable) {
console.log("inside x selection changed");
console.log("x selection changed -- ajax");
    $.ajax(
    {
      type : "POST",
      url : "{{server-root}}events/models/{{_id}}/select/x/" + variable
    });
    bookmarker.updateState( {"x-selection" : variable} );
    this.x_index = Number(variable);
  };

  ScatterPlot.prototype.y_selection_changed = function(variable) {
console.log("inside y selection changed");
console.log("y selection changed -- ajax");
    $.ajax(
    {
      type : "POST",
      url : "{{server-root}}events/models/{{_id}}/select/y/" + variable
    });
    bookmarker.updateState( {"y-selection" : variable} );
  };

  ScatterPlot.prototype.images_selection_changed = function(variable) {
console.log("inside images selection changed");
console.log("images selection changed -- ajax");
    $.ajax(
    {
      type : "POST",
      url : "{{server-root}}events/models/{{_id}}/select/images/" + variable
    });
    bookmarker.updateState( {"images-selection" : variable} );
    this.y_index = Number(variable);
  };

  ScatterPlot.prototype.open_images_changed = function(selection) {
console.log("inside open images  changed");
    // Logging every open image is too slow, so just log the count instead.
console.log("open images changed -- ajax");
    $.ajax(
    {
      type : "POST",
      url : "{{server-root}}events/models/{{_id}}/select/openimages/count/" + selection.length
    });
    bookmarker.updateState( {"open-images-selection" : selection} );
  };

  ScatterPlot.prototype.hidden_simulations_changed = function() {
console.log("inside hidden simulations  changed");
    // Logging every hidden simulation is too slow, so just log the count instead.
console.log("hidden simulations changed -- ajax");
    $.ajax(
    {
      type : "POST",
      url : "{{server-root}}events/models/{{_id}}/hidden/count/" + this.hidden_simulations.length
    });
    bookmarker.updateState( {"hidden-simulations" : this.hidden_simulations} );
  };

  ScatterPlot.prototype.update_value = function(attribute) {
console.log("inside update scatterplot value");
    if(attribute == model.metadata["column-count"] - 1)
    {
      var count = this.v.length;
      for(var i = 0; i != count; ++i)
        this.v[i] = i;
      $(this.plot_ref + " .scatterplot").scatterplot("option", {v : this.v});
    }
    else
    {
      get_model_array_attribute({
        server_root : "{{server-root}}",
        mid : "{{_id}}",
        aid : "data-table",
        array : 0,
        attribute : attribute,
        success : function(result)
        {
          $(self.plot_ref + " .scatterplot").scatterplot("option", {v : result});
        },
        error : artifact_missing
      });
    }
  };

  ScatterPlot.prototype.update_x = function(variable) {
console.log("inside update scatterplot x");
    get_model_array_attribute({
      server_root : "{{server-root}}",
      mid : "{{_id}}",
      aid : "data-table",
      array : 0,
      attribute : variable,
      success : function(result)
      {
        $(self.plot_ref + " .scatterplot").scatterplot("option", {x: result, x_label:model.metadata["column-names"][variable]});
      },
      error : artifact_missing
    });
  };

  ScatterPlot.prototype.update_y = function(variable) {
console.log("inside update scatterplot y");
    get_model_array_attribute({
      server_root : "{{server-root}}",
      mid : "{{_id}}",
      aid : "data-table",
      array : 0,
      attribute : variable,
      success : function(result)
      {
        $(self.plot_ref + " .scatterplot").scatterplot("option", {y: result, y_label:model.metadata["column-names"][variable]});
      },
      error : artifact_missing
    });
  };

  ScatterPlot.prototype.display_image = function(uri) {
console.log("inside display image");
    image_uri.href = uri.substr(0, 5) == "file:" ? uri.substr(5) : uri;
    if(image_uri.hostname in session_cache)
      this.load_image();
    else
      $("#remote-login").dialog("open");
  };

  ScatterPlot.prototype.load_image = function() {
console.log("inside load image");
    var sid = session_cache[image_uri.hostname];
    image = document.createElement("img");
    image.src = "{{server-root}}remote/" + sid + "/file" + image_uri.pathname;
    image.width = 100;
    image.style.position="absolute";
    image.style.left=10;
    image.style.top=10;
    $(this.plot_ref + " .scatterplot-pane").prepend(image);
  };

  Table.prototype.load_statistics = function(columns, callback, callback_obj) {
    // TODO what's going on with callback in terms of OO?
    // the callback does not contain the same context as "this" here does
    var self = this;
console.log(this);
console.log("inside load table statistics");
    var requests = Array();
    for(var i=0; i<columns.length; i++) {
console.log("request push -" + columns[i] + " -- ajax");
      requests.push(
        $.ajax({
          url : "{{server-root}}models/{{_id}}/arraysets/data-table/arrays/0/attributes/" + columns[i] + "/statistics",
          contentType : "application/json",
        })
      );
    }
    var defer = $.when.apply($, requests);
    defer.done(function(){
      // This is executed only after every ajax request has been completed
      $.each(arguments, function(index, responseData){
        // "responseData" contains an array of response information for each specific request
        self.statistics[parseInt(columns[index])] = responseData.length == undefined ? responseData : responseData[0];
      });
      callback.call(callback_obj || self);
    });
  };

  var model = new Model();
  model.load();
  var table = new Table();
  var layout = new Layout();
  layout.setup();

  var scatterplots = [];

  $(".plot").each(function() {
    scatter_plot = new ScatterPlot($(this).attr("id"));
    scatter_plot.controls = new Controls(scatter_plot);
    scatterplots.push(scatter_plot);
  });
});
