<!DOCTYPE html>

<!--
Copyright 2013, Sandia Corporation. Under the terms of Contract
DE-AC04-94AL85000 with Sandia Corporation, the U.S. Government retains certain
rights in this software.
-->

<html>
  <head>
    <title>Slycat Slickgrid Testing</title>
    <script type="text/javascript" src="{{server-root}}js/jquery.js"></script>
    <script type="text/javascript" src="{{server-root}}js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/jquery.event.drag-2.0.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.core.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.grid.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.rowselectionmodel.js"></script>
    <link type="text/css" rel="stylesheet" href="{{server-root}}style/slickGrid/slick.grid.css"/>
    <style>
      #table
      {
        height: 500px;
      }

      #table .slick-cell.selected
      {
        background: yellow;
      }

      #table .headerInput, #table .rowInput
      {
        background: #8f8;
      }

      #table .headerOutput, #table .rowOutput
      {
        background: #f8f;
      }
    </style>
  </head>

  <body>
    <h1>Slycat Slickgrid Testing</h1>
    <button id="clear-selection">Clear Selection</button>
    <div id="table"></div>
    <script type="text/javascript">
      $.widget("cca.table",
      {
        options:
        {
          mid : null,
          aid : null,
          inputs : [],
          outputs : [],
          others : [],
          selection : [],
          variable: null,
        },

        _create: function()
        {
          var self = this;

          $.ajax(
          {
            type : "GET",
            url : "{{server-root}}models/" + self.options.mid + "/artifacts/" + self.options.aid + "/table-metadata?generate_index=Index",
            success : function(metadata)
            {
              self.metadata = metadata;

              self.ignore_selection_change = false;

              self.data = new self._data_provider({
                mid : self.options.mid,
                aid : self.options.aid,
                inputs : self.options.inputs,
                outputs : self.options.outputs,
                others : self.options.others,
                metadata : self.metadata,
                });

              self.grid = new Slick.Grid(self.element, self.data, self.data.getColumns());
              self.grid.setSelectionModel(new Slick.RowSelectionModel());
              self.grid.onSelectedRowsChanged.subscribe(function(e, selection)
              {
                // If the two arrays are not equal
                if($(self.options.selection).not(selection.rows).length != 0 || $(selection.rows).not(self.options.selection).length != 0)
                {
                  self.options.selection = selection.rows;
                  if(!self.ignore_selection_change)
                  {
                    self.element.trigger("selection-changed", [self.options.selection]);
                  }
                }
                self.ignore_selection_change = false;
              });
              self.grid.onHeaderClick.subscribe(function (e, args)
              {
                var column = args.column.field;

                if($.inArray(column, self.options.others) != -1)
                  column = null;

                if(column != self.options.column)
                {
                  self.options.column = column;

                  if(column !== null)
                    self.element.trigger("variable-changed", [column]);
                }
              });
              self.grid.onSort.subscribe(function(e, args)
              {
                self.data.setSort(args.sortCol.field, args.sortAsc);
                self.grid.invalidate();
                self.grid.setSelectedRows([]);
              });
            }
          });
        },

        _setOption: function(key, value)
        {
          var self = this;

          if(self.options[key] == value)
            return;
          self.options[key] = value;

          if(key == "selection")
          {
            self.ignore_selection_change = true;
            self.grid.setSelectedRows(value);
          }
        },

        _data_provider: function(parameters)
        {
          var self = this;

          self.mid = parameters.mid;
          self.aid = parameters.aid;
          self.inputs = parameters.inputs;
          self.outputs = parameters.outputs;
          self.others = parameters.others;
          self.metadata = parameters.metadata;

          self.sort_column = null;
          self.sort_ascending = null;
          self.pages = {};
          self.page_size = 50;

          self.getColumns = function()
          {
            var columns = [];

            var column = self.metadata["column-count"] - 1;
            columns.push({
              id : column,
              name : self.metadata["column-names"][column],
              field : column,
              sortable : true,
              selectable : true,
              headerCssClass: "headerSimId",
              cssClass: "rowSimId",
            });

            for(var i in self.inputs)
            {
              var column = self.inputs[i];
              columns.push({
                id : column,
                name : self.metadata["column-names"][column],
                field : column,
                sortable : true,
                selectable : true,
                headerCssClass: "headerInput",
                cssClass: "rowInput",
              });
            }

            for(var i in self.outputs)
            {
              var column = self.outputs[i];
              columns.push({
                id : column,
                name : self.metadata["column-names"][column],
                field : column,
                sortable : true,
                selectable : true,
                headerCssClass: "headerOutput",
                cssClass: "rowOutput",
              });
            }

            for(var i in self.others)
            {
              var column = self.others[i];
              columns.push({
                id : column,
                name : self.metadata["column-names"][column],
                field : column,
                sortable : true,
                selectable : true,
                headerCssClass: "headerOther",
                cssClass: "rowOther",
              });
            }

            return columns;
          }

          self.getLength = function()
          {
            return self.metadata["row-count"];
          }

          self.getItem = function(index)
          {
            var column_begin = 0;
            var column_end = self.metadata["column-count"];
            var page = Math.floor(index / self.page_size);
            var page_begin = page * self.page_size;

            if(!(page in self.pages))
            {
              var row_begin = page_begin;
              var row_end = (page + 1) * self.page_size;

              var sort = "";
              if(self.sort_column !== null && self.sort_ascending !== null)
                sort = "&sort=" + self.sort_column + ":" + (self.sort_ascending ? "ascending" : "descending");

              $.ajax(
              {
                type : "GET",
                url : "{{server-root}}models/" + self.mid + "/artifacts/" + self.aid + "/table-chunk?rows=" + row_begin + "-" + row_end + "&columns=" + column_begin + "-" + column_end + "&generate_index=Index" + sort,
                async : false,
                success : function(data)
                {
                  self.pages[page] = data;
                }
              });
            }

            result = {};
            for(var i = column_begin; i != column_end; ++i)
              result[i] = self.pages[page].data[i][index - page_begin];
            return result;
          }

          self.getItemMetadata = function(index)
          {
            return null;
          }

          self.setSort = function(column, ascending)
          {
            if(column == self.sort_column && ascending == self.sort_ascending)
              return;
            self.sort_column = column;
            self.sort_ascending = ascending;
            self.pages = {};
          }
        },

      });

      $("#table")
        .bind("selection-changed", function(event, selection) { console.log("table selection changed", selection); })
        .bind("variable-changed", function(event, column) { console.log("table variable changed", column); })
        .table(
        {
          mid : "239bf4053a6641afac1e5f9d4982b6a0",
          aid : "data-table",
          inputs : [2, 3, 5, 7],
          outputs : [1, 4, 6],
          others : [0, 8],
        });

      $("#clear-selection").click(function()
      {
        $("#table").table("option", "selection", []);
      });

    </script>
  </body>
</html>
