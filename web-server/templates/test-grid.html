<!DOCTYPE html>

<!--
Copyright 2013, Sandia Corporation. Under the terms of Contract
DE-AC04-94AL85000 with Sandia Corporation, the U.S. Government retains certain
rights in this software.
-->

<html>
  <head>
    <title>Slycat Slickgrid Testing</title>
    <script type="text/javascript" src="{{server-root}}js/d3.v2.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/jquery.js"></script>
    <script type="text/javascript" src="{{server-root}}js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/jquery.event.drag-2.0.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.core.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.grid.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.rowselectionmodel.js"></script>
    <script type="text/javascript" src="{{server-root}}js/color-switcher.js"></script>
    <link type="text/css" rel="stylesheet" href="{{server-root}}style/slickGrid/slick.grid.css"/>
    <style>
      #table
      {
        height: 500px;
      }

      #table .slick-cell.selected
      {
        background: yellow;
      }

      #table .slick-cell .highlighted
      {
        color: white;
      }

      #table .headerInput, #table .rowInput
      {
        background: #8f8;
      }

      #table .headerOutput, #table .rowOutput
      {
        background: #f8f;
      }
    </style>
  </head>

  <body>
    <h1>Slycat Slickgrid Testing</h1>
    <button id="row-selection">Set Row Selection</button>
    <button id="variable-selection">Set Variable Selection</button>
    <div id="color-switcher"></div>
    <div id="table"></div>
    <script type="text/javascript">
      $.widget("cca.table",
      {
        options:
        {
          mid : null,
          aid : null,
          inputs : [],
          outputs : [],
          others : [],
          "row-selection" : [],
          "variable-selection": [],
          "sort-variable" : null,
          "sort-order" : null,
          colormap : null,
        },

        _create: function()
        {
          var self = this;

          function value_formatter(value)
          {
            return value == null ? "" : (value + "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
          }

          function cell_formatter(row, cell, value, columnDef, dataContext)
          {
            if(columnDef.colormap)
              return "<div class='highlighted' style='background:" + columnDef.colormap(value) + "'>" + value_formatter(value) + "</div>";
            return value_formatter(value);
          }

          $.ajax(
          {
            type : "GET",
            url : "{{server-root}}models/" + self.options.mid + "/artifacts/" + self.options.aid + "/table-metadata?index=Index",
            success : function(metadata)
            {
              self.metadata = metadata;

              var columns = [];
              var column = self.metadata["column-count"] - 1;
              columns.push({
                id : column,
                name : self.metadata["column-names"][column],
                field : column,
                sortable : true,
                selectable : true,
                headerCssClass: "headerSimId",
                cssClass: "rowSimId",
                formatter: cell_formatter,
              });

              for(var i in self.options.inputs)
              {
                var column = self.options.inputs[i];
                columns.push({
                  id : column,
                  name : self.metadata["column-names"][column],
                  field : column,
                  sortable : true,
                  selectable : true,
                  headerCssClass: "headerInput",
                  cssClass: "rowInput",
                  formatter: cell_formatter,
                });
              }

              for(var i in self.options.outputs)
              {
                var column = self.options.outputs[i];
                columns.push({
                  id : column,
                  name : self.metadata["column-names"][column],
                  field : column,
                  sortable : true,
                  selectable : true,
                  headerCssClass: "headerOutput",
                  cssClass: "rowOutput",
                  formatter: cell_formatter,
                });
              }

              for(var i in self.options.others)
              {
                var column = self.options.others[i];
                columns.push({
                  id : column,
                  name : self.metadata["column-names"][column],
                  field : column,
                  sortable : true,
                  selectable : true,
                  headerCssClass: "headerOther",
                  cssClass: "rowOther",
                  formatter: cell_formatter,
                });
              }

              self.data = new self._data_provider({
                mid : self.options.mid,
                aid : self.options.aid,
                metadata : self.metadata,
                sort_column : self.options["sort-variable"],
                sort_order : self.options["sort-order"],
                });

              self.trigger_row_selection = true;

              self.grid = new Slick.Grid(self.element, self.data, columns, {explicitInitialization : true, enableColumnReorder : false});
              self.grid.setSelectionModel(new Slick.RowSelectionModel());
              self.grid.onSelectedRowsChanged.subscribe(function(e, selection)
              {
                // Don't trigger a selection event unless the selection was changed by user interaction (i.e. not outside callers or changing the sort order).
                if(self.trigger_row_selection)
                {
                  self.data.get_indices("unsorted", selection.rows, function(unsorted_rows)
                  {
                    self.options["row-selection"] = unsorted_rows;
                    self.element.trigger("row-selection-changed", [unsorted_rows]);
                  });
                }
                self.trigger_row_selection = true;
              });
              self.grid.onHeaderClick.subscribe(function (e, args)
              {
                if(!self._array_equal([args.column.field], self.options["variable-selection"]))
                {
                  self.options["variable-selection"] = [args.column.field];
                  self._color_variables(self.options["variable-selection"]);
                  self.element.trigger("variable-selection-changed", [self.options["variable-selection"]]);
                }
              });
              self.grid.onSort.subscribe(function(e, args)
              {
                self.data.set_sort(args.sortCol.field, args.sortAsc ? "ascending" : "descending");
                self.data.get_indices("sorted", self.options["row-selection"], function(sorted_rows)
                {
                  self.grid.invalidate();
                  self.trigger_row_selection = false;
                  self.grid.setSelectedRows(sorted_rows);
                });
              });

              self._color_variables(self.options["variable-selection"]);

              if(self.options["sort-variable"] !== null && self.options["sort-order"] !== null)
              {
                self.grid.setSortColumn(self.options["sort-variable"], self.options["sort-order"] == "ascending");
              }

              self.data.get_indices("sorted", self.options["row-selection"], function(sorted_rows)
              {
                self.trigger_row_selection = false;
                self.grid.setSelectedRows(sorted_rows);
              });

              self.grid.init();
            }
          });
        },

        _setOption: function(key, value)
        {
          var self = this;

          if(key == "row-selection")
          {
            if(self._array_equal(self.options[key], value))
              return;

            self.options[key] = value;
            self.data.get_indices("sorted", value, function(sorted_rows)
            {
              self.trigger_row_selection = false;
              self.grid.setSelectedRows(sorted_rows);
            });
          }
          else if(key == "variable-selection")
          {
            if(self._array_equal(self.options[key], value))
              return;

            self.options[key] = value;
            self._color_variables(value);
          }
          else if(key == "colormap")
          {
            self.options[key] = value;
            self._color_variables(self.options["variable-selection"])
          }
        },

        _color_variables: function(variables)
        {
          var self = this;

          var columns = self.grid.getColumns();
          for(var i in columns)
          {
            var column = columns[i];
            if(self.options.colormap !== null && $.inArray(column.id, variables) != -1 && $.inArray(column.id, self.options.others) == -1)
            {
              // Make a copy of our global colormap, then adjust its domain to match our column-specific data.
              column.colormap = self.options.colormap.copy();

              var new_domain = []
              var domain_scale = d3.scale.linear().domain([0, column.colormap.range().length]).range([self.metadata["column-min"][column.id], self.metadata["column-max"][column.id]]);
              for(var i in column.colormap.range())
                new_domain.push(domain_scale(i));
              column.colormap.domain(new_domain);
            }
            else
            {
              column.colormap = null;
            }
          }

          self.grid.invalidate();
        },

        _data_provider: function(parameters)
        {
          var self = this;

          self.mid = parameters.mid;
          self.aid = parameters.aid;
          self.metadata = parameters.metadata;
          self.sort_column = parameters.sort_column;
          self.sort_order = parameters.sort_order;

          self.pages = {};
          self.page_size = 50;

          self.getLength = function()
          {
            return self.metadata["row-count"];
          }

          self.getItem = function(index)
          {
            var column_begin = 0;
            var column_end = self.metadata["column-count"];
            var page = Math.floor(index / self.page_size);
            var page_begin = page * self.page_size;

            if(!(page in self.pages))
            {
              var row_begin = page_begin;
              var row_end = (page + 1) * self.page_size;

              var sort = "";
              if(self.sort_column !== null && self.sort_order !== null)
                sort = "&sort=" + self.sort_column + ":" + self.sort_order;

              $.ajax(
              {
                type : "GET",
                url : "{{server-root}}models/" + self.mid + "/artifacts/" + self.aid + "/table-chunk?rows=" + row_begin + "-" + row_end + "&columns=" + column_begin + "-" + column_end + "&index=Index" + sort,
                async : false,
                success : function(data)
                {
                  self.pages[page] = data;
                }
              });
            }

            result = {};
            for(var i = column_begin; i != column_end; ++i)
              result[i] = self.pages[page].data[i][index - page_begin];
            return result;
          }

          self.getItemMetadata = function(index)
          {
            return null;
          }

          self.set_sort = function(column, order)
          {
            if(column == self.sort_column && order == self.sort_order)
              return;
            self.sort_column = column;
            self.sort_order = order;
            self.pages = {};
          },

          self.get_indices = function(direction, rows, callback)
          {
            if(rows.length == 0)
            {
              callback([]);
              return;
            }

            var sort = "";
            if(self.sort_column !== null && self.sort_order !== null)
              sort = "&sort=" + self.sort_column + ":" + self.sort_order;

            function is_little_endian()
            {
              if(this.result === undefined)
                this.result = ((new Uint32Array((new Uint8Array([1,2,3,4])).buffer))[0] === 0x04030201);
              return this.result;
            }

            var request = new XMLHttpRequest();
            request.open("GET", "{{server-root}}models/" + self.mid + "/artifacts/" + self.aid + "/table-" + direction + "-indices?rows=" + rows.join(",") + "&index=Index&byteorder=" + (is_little_endian() ? "little" : "big") + sort);
            request.responseType = "arraybuffer";
            request.callback = callback;
            request.onload = function(e)
            {
              this.callback(new Int32Array(this.response));
            }
            request.send();
          }
        },

        _array_equal: function(a, b)
        {
          return $(a).not(b).length == 0 && $(b).not(a).length == 0;
        },

      });

      $("#color-switcher").colorswitcher({colormap : "rainbow"});
      $("#color-switcher").bind("colormap-changed", function(event, colormap)
      {
        $("#table").table("option", {colormap: $("#color-switcher").colorswitcher("get_color_map", colormap)});
      });
      $("#table")
        .bind("row-selection-changed", function(event, selection) { console.log("row selection changed", selection); })
        .bind("variable-selection-changed", function(event, selection) { console.log("variable selection changed", selection); })
        .table(
        {
          mid : "239bf4053a6641afac1e5f9d4982b6a0",
          aid : "data-table",
          inputs : [2, 3, 5, 7],
          outputs : [1, 4, 6],
          others : [0, 8],
          "row-selection" : [7, 8, 9],
          "variable-selection" : [9],
//          "sort-variable" : 0,
//          "sort-order" : "ascending",
          colormap : $("#color-switcher").colorswitcher("get_color_map", $("#color-switcher").colorswitcher("option", "colormap")),
        });

      $("#row-selection").click(function()
      {
        $("#table").table("option", "row-selection", [0, 1, 2, 3]);
      });

      $("#variable-selection").click(function()
      {
        $("#table").table("option", "variable-selection", [2]);
      });


    </script>
  </body>
</html>
