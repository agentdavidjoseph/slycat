<!DOCTYPE html>

<!--
Copyright 2013, Sandia Corporation. Under the terms of Contract
DE-AC04-94AL85000 with Sandia Corporation, the U.S. Government retains certain
rights in this software.
-->

<html>
  <head>
    <title>Slycat Grid Testing</title>
    <script type="text/javascript" src="{{server-root}}js/jquery.js"></script>
    <script type="text/javascript" src="{{server-root}}js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/jquery.event.drag-2.0.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.core.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.grid.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.rowselectionmodel.js"></script>
    <link type="text/css" rel="stylesheet" href="{{server-root}}style/slickGrid/slick.grid.css"/>
    <style>
      #grid
      {
        height: 500px;
      }

      #grid .slick-cell.selected
      {
        background: yellow;
      }

      #grid .headerInput, #grid .rowInput
      {
        background: #8f8;
      }

      #grid .headerOutput, #grid .rowOutput
      {
        background: #f8f;
      }
    </style>
  </head>

  <body>
    <button id="clear-selection">Clear Selection</button>
    <div id="grid"></div>
    <script type="text/javascript">
      function data_provider(parameters)
      {
        var self = this;

        self.mid = parameters.mid;
        self.aid = parameters.aid;
        self.inputs = parameters.inputs;
        self.outputs = parameters.outputs;
        self.others = parameters.others;

        self.sort_column = null;
        self.sort_ascending = null;
        self.pages = {};
        self.page_size = 50;

        $.ajax(
        {
          type : "GET",
          url : "{{server-root}}models/" + self.mid + "/artifacts/" + self.aid + "/table-metadata?generate_index=Index",
          async : false,
          success : function(metadata)
          {
            self.metadata = metadata;
          }
        });

        self.getColumns = function()
        {
          var columns = [];

          var column = self.metadata["column-count"] - 1;
          columns.push({
            id : column,
            name : self.metadata["column-names"][column],
            field : column,
            sortable : true,
            selectable : true,
            headerCssClass: "headerSimId",
            cssClass: "rowSimId",
          });

          for(var i in self.inputs)
          {
            var column = self.inputs[i];
            columns.push({
              id : column,
              name : self.metadata["column-names"][column],
              field : column,
              sortable : true,
              selectable : true,
              headerCssClass: "headerInput",
              cssClass: "rowInput",
            });
          }

          for(var i in self.outputs)
          {
            var column = self.outputs[i];
            columns.push({
              id : column,
              name : self.metadata["column-names"][column],
              field : column,
              sortable : true,
              selectable : true,
              headerCssClass: "headerOutput",
              cssClass: "rowOutput",
            });
          }

          for(var i in self.others)
          {
            var column = self.others[i];
            columns.push({
              id : column,
              name : self.metadata["column-names"][column],
              field : column,
              sortable : true,
              selectable : true,
              headerCssClass: "headerOther",
              cssClass: "rowOther",
            });
          }

          return columns;
        }

        self.getLength = function()
        {
          return self.metadata["row-count"];
        }

        self.getItem = function(index)
        {
          var column_begin = 0;
          var column_end = self.metadata["column-count"];
          var page = Math.floor(index / self.page_size);
          var page_begin = page * self.page_size;

          if(!(page in self.pages))
          {
            var row_begin = page_begin;
            var row_end = (page + 1) * self.page_size;

            var sort = "";
            if(self.sort_column !== null && self.sort_ascending !== null)
              sort = "&sort=" + self.sort_column + ":" + (self.sort_ascending ? "ascending" : "descending");

            $.ajax(
            {
              type : "GET",
              url : "{{server-root}}models/" + self.mid + "/artifacts/" + self.aid + "/table-chunk?rows=" + row_begin + "-" + row_end + "&columns=" + column_begin + "-" + column_end + "&generate_index=Index" + sort,
              async : false,
              success : function(data)
              {
                self.pages[page] = data;
              }
            });
          }

          result = {};
          for(var i = column_begin; i != column_end; ++i)
            result[i] = self.pages[page].data[i][index - page_begin];
          return result;
        }

        self.getItemMetadata = function(index)
        {
          return null;
        }

        self.setSort = function(column, ascending)
        {
          if(column == self.sort_column && ascending == self.sort_ascending)
            return;
          self.sort_column = column;
          self.sort_ascending = ascending;
          self.pages = {};
        }
      }

      var data = new data_provider({
        mid : "239bf4053a6641afac1e5f9d4982b6a0",
        aid : "data-table",
        inputs : [2, 3, 5, 7],
        outputs : [1, 4, 6],
        others : [0, 8]
        });
      var grid = new Slick.Grid("#grid", data, data.getColumns());
      var ignore_selection_change = false;

      grid.setSelectionModel(new Slick.RowSelectionModel());
      grid.onSelectedRowsChanged.subscribe(function(e, selection)
      {
        if(!ignore_selection_change)
          console.log("row-selection-changed", selection.rows);
        ignore_selection_change = false;
      });
      $("#clear-selection").click(function()
      {
        ignore_selection_change = true;
        grid.setSelectedRows([]);
      });
      grid.onSort.subscribe(function(e, args)
      {
        data.setSort(args.sortCol.field, args.sortAsc);
        grid.invalidate();
        ignore_selection_change = true;
        grid.setSelectedRows([]);
      });
      grid.onHeaderClick.subscribe(function (e, args)
      {
        var column = args.column.field;
        if($.inArray(column, data.others) != -1)
          return;

        console.log("variable-changed", column);
      });
    </script>
  </body>
</html>
