<!DOCTYPE html>

<!--
Copyright 2013, Sandia Corporation. Under the terms of Contract
DE-AC04-94AL85000 with Sandia Corporation, the U.S. Government retains certain
rights in this software.
-->

<html>
  <head>
    <title>Slycat Slickgrid Testing</title>
    <script type="text/javascript" src="{{server-root}}js/jquery.js"></script>
    <script type="text/javascript" src="{{server-root}}js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/jquery.event.drag-2.0.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.core.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.grid.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.rowselectionmodel.js"></script>
    <link type="text/css" rel="stylesheet" href="{{server-root}}style/slickGrid/slick.grid.css"/>
    <style>
      #table
      {
        height: 500px;
      }

      #table .slick-cell.selected
      {
        background: yellow;
      }

      #table .headerInput, #table .rowInput
      {
        background: #8f8;
      }

      #table .headerOutput, #table .rowOutput
      {
        background: #f8f;
      }
    </style>
  </head>

  <body>
    <h1>Slycat Slickgrid Testing</h1>
    <button id="row-selection">Set Row Selection</button>
    <button id="variable-selection">Set Variable Selection</button>
    <div id="table"></div>
    <script type="text/javascript">
      $.widget("cca.table",
      {
        options:
        {
          mid : null,
          aid : null,
          inputs : [],
          outputs : [],
          others : [],
          "row-selection" : [],
          "variable-selection": [],
        },

        _create: function()
        {
          var self = this;

          function array_equal(a, b)
          {
            return $(a).not(b).length == 0 && $(b).not(a).length == 0;
          }

          $.ajax(
          {
            type : "GET",
            url : "{{server-root}}models/" + self.options.mid + "/artifacts/" + self.options.aid + "/table-metadata?generate_index=Index",
            success : function(metadata)
            {
              self.metadata = metadata;

              var columns = [];
              var column = self.metadata["column-count"] - 1;
              columns.push({
                id : column,
                name : self.metadata["column-names"][column],
                field : column,
                sortable : true,
                selectable : true,
                headerCssClass: "headerSimId",
                cssClass: "rowSimId",
              });

              for(var i in self.options.inputs)
              {
                var column = self.options.inputs[i];
                columns.push({
                  id : column,
                  name : self.metadata["column-names"][column],
                  field : column,
                  sortable : true,
                  selectable : true,
                  headerCssClass: "headerInput",
                  cssClass: "rowInput",
                });
              }

              for(var i in self.options.outputs)
              {
                var column = self.options.outputs[i];
                columns.push({
                  id : column,
                  name : self.metadata["column-names"][column],
                  field : column,
                  sortable : true,
                  selectable : true,
                  headerCssClass: "headerOutput",
                  cssClass: "rowOutput",
                });
              }

              for(var i in self.options.others)
              {
                var column = self.options.others[i];
                columns.push({
                  id : column,
                  name : self.metadata["column-names"][column],
                  field : column,
                  sortable : true,
                  selectable : true,
                  headerCssClass: "headerOther",
                  cssClass: "rowOther",
                });
              }

              self.data = new self._data_provider({
                mid : self.options.mid,
                aid : self.options.aid,
                metadata : self.metadata,
                });

              self.grid = new Slick.Grid(self.element, self.data, columns);
              self.grid.setSelectionModel(new Slick.RowSelectionModel());
              self.grid.onSelectedRowsChanged.subscribe(function(e, selection)
              {
                // If the selection was changed by an external caller, this code will not be called.
                if(! array_equal(selection.rows, self.options["row-selection"]))
                {
                  self.options["row-selection"] = selection.rows;
                  self.element.trigger("row-selection-changed", [self.options["row-selection"]]);
                }
              });
              self.grid.onHeaderClick.subscribe(function (e, args)
              {
                // If the selection was changed by an external caller, this code will not be called.
                if(! array_equal([args.column.field], self.options["variable-selection"]))
                {
                  self.options["variable-selection"] = [args.column.field];
                  self.element.trigger("variable-selection-changed", [self.options["variable-selection"]]);
                }
              });
              self.grid.onSort.subscribe(function(e, args)
              {
                self.data.set_sort(args.sortCol.field, args.sortAsc);
                self.grid.invalidate();
                self.grid.setSelectedRows([]);
              });
            }
          });
        },

        _setOption: function(key, value)
        {
          var self = this;

          if(self.options[key] == value)
            return;
          self.options[key] = value;

          if(key == "row-selection")
          {
            self.grid.setSelectedRows(value);
          }
          else if(key == "variable-selection")
          {
            console.log("setting variable selection", value);
          }
        },

        _data_provider: function(parameters)
        {
          var self = this;

          self.mid = parameters.mid;
          self.aid = parameters.aid;
          self.metadata = parameters.metadata;

          self.sort_column = null;
          self.sort_ascending = null;
          self.pages = {};
          self.page_size = 50;

          self.getLength = function()
          {
            return self.metadata["row-count"];
          }

          self.getItem = function(index)
          {
            var column_begin = 0;
            var column_end = self.metadata["column-count"];
            var page = Math.floor(index / self.page_size);
            var page_begin = page * self.page_size;

            if(!(page in self.pages))
            {
              var row_begin = page_begin;
              var row_end = (page + 1) * self.page_size;

              var sort = "";
              if(self.sort_column !== null && self.sort_ascending !== null)
                sort = "&sort=" + self.sort_column + ":" + (self.sort_ascending ? "ascending" : "descending");

              $.ajax(
              {
                type : "GET",
                url : "{{server-root}}models/" + self.mid + "/artifacts/" + self.aid + "/table-chunk?rows=" + row_begin + "-" + row_end + "&columns=" + column_begin + "-" + column_end + "&generate_index=Index" + sort,
                async : false,
                success : function(data)
                {
                  self.pages[page] = data;
                }
              });
            }

            result = {};
            for(var i = column_begin; i != column_end; ++i)
              result[i] = self.pages[page].data[i][index - page_begin];
            return result;
          }

          self.getItemMetadata = function(index)
          {
            return null;
          }

          self.set_sort = function(column, ascending)
          {
            if(column == self.sort_column && ascending == self.sort_ascending)
              return;
            self.sort_column = column;
            self.sort_ascending = ascending;
            self.pages = {};
          }
        },

      });

      $("#table")
        .bind("row-selection-changed", function(event, selection) { console.log("row selection changed", selection); })
        .bind("variable-selection-changed", function(event, selection) { console.log("variable selection changed", selection); })
        .table(
        {
          mid : "239bf4053a6641afac1e5f9d4982b6a0",
          aid : "data-table",
          inputs : [2, 3, 5, 7],
          outputs : [1, 4, 6],
          others : [0, 8],
        });

      $("#row-selection").click(function()
      {
        $("#table").table("option", "row-selection", [0, 1, 2, 5]);
      });

      $("#variable-selection").click(function()
      {
        $("#table").table("option", "variable-selection", [2]);
      });

    </script>
  </body>
</html>
