<!DOCTYPE html>

<!--
Copyright 2013, Sandia Corporation. Under the terms of Contract
DE-AC04-94AL85000 with Sandia Corporation, the U.S. Government retains certain
rights in this software.
-->

<html>
  <head>
{{> head}}
    <title>{{name}} - Slycat CCA Model (canvas)</title>
    <script type="text/javascript" src="{{server-root}}js/jquery-layout.js"></script>
    <script type="text/javascript" src="{{server-root}}js/jquery.mousewheel.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/jquery.ba-dotimeout.js"></script>
    <script type="text/javascript" src="{{server-root}}js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/jquery.ba-bbq.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/d3.js"></script>
    <script type="text/javascript" src="{{server-root}}js/sort-table.js"></script>
    <script type="text/javascript" src="{{server-root}}js/modernizr.js"></script>
    <script type="text/javascript" src="{{server-root}}js/bookmarker.js"></script>
    <script type="text/javascript" src="{{server-root}}js/color-mapper.js"></script>

    <!-- SlickGrid sources -->
    <script type="text/javascript" src="{{server-root}}js/slickGrid/jquery.event.drag-2.0.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/jquery.jsonp-1.1.0.min.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.core.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.grid.js"></script>
    <script type="text/javascript" src="{{server-root}}js/table-cca-simulation.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.ccaloader.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.rowselectionmodel.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.headerbuttons.js"></script>
    <script type="text/javascript" src="{{server-root}}js/slickGrid/slick.autotooltips.js"></script>

    <link rel="stylesheet" href="{{server-root}}style/model-cca.css" type="text/css">

    <!-- SlickGrid styles -->
    <link rel="stylesheet" href="{{server-root}}style/slickGrid/slick.grid.css" type="text/css"/>
    <link rel="stylesheet" href="{{server-root}}style/slickGrid/slick-default-theme.css" type="text/css"/>
    <link rel="stylesheet" href="{{server-root}}style/slickGrid/slick-slycat-theme.css" type="text/css"/>
    <link rel="stylesheet" href="{{server-root}}style/slickGrid/slick.headerbuttons.css" type="text/css"/>

  </head>

  <body class="cca">
    <div class="ui-layout-north">
{{> header}}

      <div id="page-title">
        <div class="width-wrapper">
          <div class="marking">{{{marking-html}}}</div>
          <button id="edit-model-button" title="Edit this model's name and description.">Edit Model</button>
          <button id="rerun-cca-button" title="Rerun this model using different parameters.">Rerun Model</button>
          <div id="breadcrumbs">
            <a href="{{server-root}}projects">Projects</a> &rarr;
            {{#full-project}}<a href="{{server-root}}projects/{{_id}}" id="project-link">{{name}}</a> &rarr;{{/full-project}}
          </div>
          <h2>{{name}}</h2>
          <div id="model-desc">{{description}}</div>
          <div id="color-switcher-container"></div>
          <div id="status-messages" style="display: none;">
            <div class='error-heading'>Oops, this model is not ready yet.</div>
            <div class='error-description'>We are probabably building it for your right now. We'll load it for you automatically once it's ready. Look up at the status bar for progress information and more details.</div>
            <div><a href="#" onClick="$('#status-messages .technical-details').show(); return false;">Show Technical Information</a></div>
            <div class="technical-details" style="display: none;"></div>
          </div>
          <div id="edit-model">
            <div id="edit-model-form" class="dialog" title="Edit Model">
              <button id="delete-model-link">Delete Model</button>
              <label for="edit-model-name">Model Name</label>
              <input id="edit-model-name" class="text ui-widget-content ui-corner-all" value="{{name}}" />
              <label for="edit-model-description">Description</label>
              <textarea id="edit-model-description" class="text ui-widget-content ui-corner-all" rows="3" cols="20">{{description}}</textarea>
            </div>
          </div>

          <!-- Rerun CCA user interface -->
          <div id="rerun-cca-form" class="dialog" title="Rerun CCA Model">
            <div id="rerun-cca-basics">
              <label for="rerun-cca-name">Model Name</label>
              <input id="rerun-cca-name" class="text ui-widget-content ui-corner-all" value="{{new-model-name}}" />
              <label for="rerun-cca-description">Description</label>
              <textarea id="rerun-cca-description" class="text ui-widget-content ui-corner-all" rows="3" cols="20"></textarea>
            </div>

            <div id="rerun-cca-parameters">
              <table id="rerun-cca-variables">
                <thead>
                  <tr><th>Variable</th><th>Input</th><th>Output</th></tr>
                  <tr>
                    <td></td>
                    <td><button id="rerun-cca-all-inputs-on" title="Turn all inputs on.">On</button><button id="rerun-cca-all-inputs-off" title="Turn all inputs off.">Off</button></td>
                    <td><button id="rerun-cca-all-outputs-on" title="Turn all outputs on.">On</button><button id="rerun-cca-all-outputs-off" title="Turn all outputs off.">Off</button></td>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>

              <div>
                <p><input id="rerun-cca-scale-inputs" type="checkbox"></input>Scale inputs to unit variance.</p>
              </div>
            </div>
          </div>


        </div>
      </div>
    </div>

    <div id="content-pane" class="ui-layout-center">
      <div id="cca-pane" class="ui-layout-north">
        <div id="cca-component-pane" class="ui-layout-center">
          <div id="cca-component">
            <div id="errors" style="display:none">
              <h2>Errors</h2>
              <table>
                <tbody id="error-table"></tbody>
              </table>
            </div>
            <table id="cca-table">
            </table>
          </div>
        </div>
        <div id="scatterplot-pane" class="ui-layout-east">
          <canvas id="scatterplot-canvas" width="300" height="300" style="width: 300px; height: 300px;"></canvas>
        </div>
      </div>
      <div id="simulation-pane" class="ui-layout-center">
        <div id="simulation-table-pane" class="ui-layout-center">
        </div>
      </div>
    </div>

    <div id="footer" class="ui-layout-south">
      <div class="width-wrapper">
        <ul id="footer-links">
          {{#is-project-administrator}}
          <li class="admin">
            <a href="{{server-root}}models/{{_id}}/design">Design View</a>
          </li>
          {{/is-project-administrator}}
        </ul>
      </div>
    </div>

    <script type="text/javascript">
      $(document).ready(function()
      {
        // Start up a bookmark manager
        var bookmarker = new bookmark_manager("{{server-root}}", "{{#full-project}}{{_id}}{{/full-project}}", "{{_id}}");
        var bookmark = bookmarker.getState();

        // Start up a color mapper
        var colorMapper = new color_mapper();
        // Add controls for switching between different color maps
        colorMapper.addSwitcher($('#color-switcher-container'), bookmark, updateColorMap);
        // Callback function called by colorMapper when user clicks on a different color map choice
        function updateColorMap(colorMapName){
          if(cca_simulation_table_instance != null && colorMapName != null) {
            cca_simulation_table_instance.updateColorMap(colorMapName);
            cca_scatterplot.update({color:true});
            bookmarker.updateState( {"colormap" : colorMapName} );
          }
        }

        // Setup the model edit form ...
        $("#edit-model-form").dialog(
        {
          autoOpen: false,
          width: 700,
          height: 300,
          modal: true,
          buttons:
          {
            "Save Changes": function()
            {
              var model =
              {
                "name" : $("#edit-model-name").val(),
                "description" : $("#edit-model-description").val()
              };

              $.ajax(
              {
                type : "PUT",
                url : "{{server-root}}models/{{_id}}",
                contentType : "application/json",
                data : $.toJSON(model),
                processData : false,
                success : function()
                {
                  window.location.reload();
                },
                error : function(request, status, reason_phrase)
                {
                  window.alert("Error updating model: " + reason_phrase);
                }
              });
            },
            Cancel: function()
            {
              $(this).dialog("close");
            }
          },
          close: function()
          {
          }
        });

        $("#delete-model-link").click(function(){
          if(!window.confirm("Delete model {{name}}?  This cannot be undone."))
            return false;

          $.ajax(
          {
            type : "DELETE",
            url : "{{server-root}}models/{{_id}}",
            success : function(details)
            {
              window.location.href = "{{server-root}}projects/{{#full-project}}{{_id}}{{/full-project}}";
            },
            error : function(request, status, reason_phrase)
            {
              window.alert("Error deleting model: " + reason_phrase);
            }
          });
        });

        $("#edit-model-button").button().click(function()
        {
          $("#edit-model-form").dialog("open");
          $("#edit-model-name").focus();
        });

        // Setup the Rerun Model form ...
        rerun_cca_worker = null;
        $("#rerun-cca-form").dialog(
        {
          autoOpen: false,
          width: 700,
          height: 700,
          modal: true,
          open : function()
          {
            $("#rerun-cca-basics").css("display", "block");
            $("#rerun-cca-parameters").css("display", "none");
            $(".ui-dialog-buttonpane button:contains('Previous')").button("disable");
            $(".ui-dialog-buttonpane button:contains('Next')").button("enable");
            $(".ui-dialog-buttonpane button:contains('Run')").button("disable");
          },
          close : function()
          {
            if(rerun_cca_worker)
            {
              $.ajax(
              {
                type : "DELETE",
                url : "{{server-root}}workers/" + rerun_cca_worker,
                error : function(request, status, reason_phrase)
                {
                  window.alert("Error closing local worker: " + reason_phrase);
                }
              });
              rerun_cca_worker = null;
            }
          },
          buttons:
          {
            "Previous" : function(){
              $("#rerun-cca-basics").css("display", "block");
              $("#rerun-cca-parameters").css("display", "none");
              $(".ui-dialog-buttonpane button:contains('Next')").button("enable");
              $(".ui-dialog-buttonpane button:contains('Run')").button("disable");
              $(".ui-dialog-buttonpane button:contains('Previous')").button("disable");
            },
            "Next" : function(){
              $(".ui-dialog-buttonpane button:contains('Next')").button("disable");
              $(".ui-dialog-buttonpane button:contains('Run')").button("enable");
              $(".ui-dialog-buttonpane button:contains('Previous')").button("enable");
              $.ajax(
              {
                type : "POST",
                url : "{{server-root}}projects/{{#full-project}}{{_id}}{{/full-project}}/models",
                contentType : "application/json",
                data: $.toJSON(
                {
                  "model-type" : "cca3",
                  "name" : $("#rerun-cca-name").val(),
                  "marking" : "{{marking}}",
                  "description" : $("#rerun-cca-description").val()
                }),
                processData: false,
                success: function(result)
                {
                  rerun_cca_worker = result["wid"];
                  $.ajax(
                  {
                    type : "POST",
                    url : "{{server-root}}workers/" + rerun_cca_worker + "/model/copy-model-inputs",
                    contentType : "application/json",
                    data: $.toJSON(
                    {
                      "mid" : "{{_id}}"
                    }),
                    processData: false,
                    success: function(result)
                    {
                      $.ajax(
                      {
                        type : "GET",
                        url : "{{server-root}}workers/" + rerun_cca_worker + "/model/table-columns",
                        data :
                        {
                          name : "data-table"
                        },
                        success : function(table)
                        {
                          function deselect_companion(companion)
                          {
                            return function()
                            {
                              companion.removeAttr("checked");
                            }
                          }
                          $("#rerun-cca-variables tbody").empty();
                          $.each(table["column-names"], function(index, column)
                          {
                            var row = $("<tr>").appendTo($("#rerun-cca-variables tbody"));
                            $("<td>").text(column).appendTo(row);

                            if(table["column-types"][index] == "double")
                            {
                              var input = $("<input type='checkbox' name='inputs' class='rerun-cca-input-variable' title='Treat variable as an input for analysis.'>").val(index).appendTo($("<td>").appendTo(row));
                              var output = $("<input type='checkbox' name='outputs' class='rerun-cca-output-variable' title='Treat variable as an output for analysis.'>").val(index).appendTo($("<td>").appendTo(row));

                              if(jQuery.inArray(index, input_columns) != -1)
                                input.attr("checked", "checked");
                              if(jQuery.inArray(index, output_columns) != -1)
                                output.attr("checked", "checked");

                              input.click(deselect_companion(output));
                              output.click(deselect_companion(input));
                            }
                            else
                            {
                              $("<td colspan='2' title='Cannot analyze non-numeric data.'>").appendTo(row);
                            }
                          });
                          $("#rerun-cca-basics").css("display", "none");
                          $("#rerun-cca-parameters").css("display", "block");
                        },
                        error: function(request, status, reason_phrase)
                        {
                          window.alert("Error creating model: " + reason_phrase);
                        }
                      });
                    },
                    error: function(request, status, reason_phrase)
                    {
                      window.alert("Error creating model: " + reason_phrase);
                    }
                  });
                },
                error: function(request, status, reason_phrase)
                {
                  window.alert("Error creating model: " + reason_phrase);
                }
              });
            },
            "Run" : function(){
              function set_parameter(name, value)
              {
                $.ajax(
                {
                  async : false,
                  type : "POST",
                  url : "{{server-root}}workers/" + rerun_cca_worker + "/model/set-parameter",
                  contentType : "application/json",
                  data: $.toJSON(
                  {
                    name : name,
                    value : value
                  }),
                  processData : false,
                  error: function(request, status, reason_phrase)
                  {
                    window.alert("Error setting model parameter: " + reason_phrase);
                  }
                });
              }

              input_columns = [];
              $(".rerun-cca-input-variable:checked").each(function(index, element) { input_columns.push(Number($(element).val())); });
              set_parameter("input-columns", input_columns);

              output_columns = [];
              $(".rerun-cca-output-variable:checked").each(function(index, element) { output_columns.push(Number($(element).val())); });
              set_parameter("output-columns", output_columns);

              set_parameter("scale-inputs", $("#rerun-cca-scale-inputs").attr("checked"));

              $.ajax(
              {
                type : "POST",
                url : "{{server-root}}workers/" + rerun_cca_worker + "/model/finish-model",
                contentType : "application/json",
                data: $.toJSON(
                {
                }),
                processData: false,
                success: function(result)
                {
                  rerun_cca_worker = null;
                  window.alert("Model scheduled for generation.  Watch the worker pane to see when it completes.");
                  $("#rerun-cca-form").dialog("close");
                },
                error: function(request, status, reason_phrase)
                {
                  window.alert("Error creating model: " + reason_phrase);
                }
              });
            },
            Cancel : function(){
              $(this).dialog("close");
            }
          }
        });

        $("#rerun-cca-all-inputs-on").button().click(function()
        {
          $(".rerun-cca-input-variable").attr("checked", "checked");
          $(".rerun-cca-output-variable").removeAttr("checked");
        });
        $("#rerun-cca-all-inputs-off").button().click(function()
        {
          $(".rerun-cca-input-variable").removeAttr("checked");
        });
        $("#rerun-cca-all-outputs-on").button().click(function()
        {
          $(".rerun-cca-output-variable").attr("checked", "checked");
          $(".rerun-cca-input-variable").removeAttr("checked");
        });
        $("#rerun-cca-all-outputs-off").button().click(function()
        {
          $(".rerun-cca-output-variable").removeAttr("checked");
        });

        $("#rerun-cca-button").button().click(function()
        {
          $("#rerun-cca-form").dialog("open");
        });

        // Verify that we have all required inputs before setting-up the rest of the visualization ...
        var input_columns = {{input-columns}};
        var output_columns = {{output-columns}};
        var scale_inputs = {{scale-inputs}};
        var statistics = null;
        var canonical_variables = null;
        var x_structure_correlation = null;
        var y_structure_correlation = null;

        // Creating a canonical-variables array chunker worker and getting the canonical-variables from it
        canonical_variables = getAllArrayChunkerData("canonical-variables");

        // Creating a cca-statistics array chunker worker and getting the cca-statistics from it
        statistics = getAllArrayChunkerData("cca-statistics");

        // Creating a input-structure-correlation array chunker worker and getting the input-structure-correlation from it
        x_structure_correlation = getAllArrayChunkerData("input-structure-correlation");

        // Creating a output-structure-correlation array chunker worker and getting the output-structure-correlation from it
        y_structure_correlation = getAllArrayChunkerData("output-structure-correlation");

        function getAllArrayChunkerData(modelArtifactName){
          return getArrayChunkerData( createArrayChunker(modelArtifactName) );
        }

        function createArrayChunker(modelArtifactName) {
          var workerId = null;
          $.ajax(
            {
              contentType : "application/json",
              data : $.toJSON({ type : "array-chunker", "mid" : "{{_id}}", "artifact" : modelArtifactName, }),
              processData : false,
              type : "POST",
              cache: false,
              url : "{{server-root}}" + "workers",
              async: false, // Much of the rest of the script relies on this array chunker, so doing this synchronously
              success : function(worker)
              {
                // setup beforeunload handler to stop and delete worker when user leaves page
                $(window).bind('beforeunload', function(){
                  stopWorker(worker); 
                  deleteWorker(worker);
                });

                workerId = worker.id;
              },
              error : function(request, status, reason_phrase)
              {
                //window.alert("Error creating " + modelArtifactName + " array-chunker worker: " + reason_phrase);
              },
            }
          );
          return workerId;
        }

        function getChunkerMetadata(workerId, chunkerType){
          var metadata = null;
          if (workerId != null) {
            $.ajax({
              url : "{{server-root}}" + "workers/" + workerId + "/" + chunkerType + "/metadata",
              contentType : "application/json",
              async: false, // Much of the rest of the script relies on this metadata, so dong this synchronously
              success: function(resp){
                metadata = resp;
              },
              error: function(request, status, reason_phrase){
                window.alert("Error getting metadata from table-chunker worker: " + reason_phrase);
              }
            });
          }
          return metadata;
        }

        function getArrayChunkerData(workerId){
          if (workerId != null) {
            var metadata = getChunkerMetadata(workerId, "array-chunker");
            var allAttributes = [];
            for(var i = 0; i < metadata.attributes.length; i++) {
              allAttributes.push(i);
            }

            var dimensions = metadata.dimensions;
            var allRanges = [];
            for(var i = 0; i < dimensions.length; i++) {
              allRanges.push( dimensions[i].begin );
              allRanges.push( dimensions[i].end );
            }

            var queryParams = {
              "attributes" : allAttributes.join(","),
              "ranges" : allRanges.join(","),
            }

            var arrayChunkerData = null;
            req = $.ajax({
              url : "{{server-root}}" + "workers/" + workerId + "/array-chunker/chunk",
              contentType : "application/json",
              data: queryParams,
              processData : true,
              dataType: 'json',
              async: false, // Much of the rest of the script relies on this data, so dong this synchronously
              success: function(resp){
                arrayChunkerData = resp;
              },
              error: function(xhr, ajaxOptions, thrownError){
                  //onError(fromPage, toPage, xhr, ajaxOptions, thrownError)
              }
            });
            return arrayChunkerData;
          } else {
            return null;
          }
        }

        if(input_columns === null || output_columns === null || scale_inputs === null || statistics === null || canonical_variables === null || x_structure_correlation === null || y_structure_correlation === null) {
          $("#status-messages").show();
          $("#status-messages .technical-details").append("<pre>Required inputs are not present.</pre>");
          setTimeout("location.reload(true);", 15000);
          return;
        }

        // OK, setup the visualization ...
        function deleteWorker(worker)
        {
          $.ajax(
          {
            type : "DELETE",
            url : "{{server-root}}" + "workers/" + worker.id,
            async: false,
            success : function()
            {
            },
            error : function(request, status, reason_phrase)
            {
              //window.alert("Error deleting remote worker: " + reason_phrase);
            }
          });
        }

        function stopWorker(worker)
        {
          $.ajax(
          {
            contentType : "application/json",
            data : $.toJSON({ result : "stopped" }),
            processData : false,
            type : "PUT",
            url : "{{server-root}}" + "workers/" + worker.id,
            async: false, // Need to do this synchonously since it's called by the beforeunload even and will not happen otherwise.
            timeout: 3000, // Setting timeout to a few seconds so user is not waiting forever after trying to leave page if worker can't be stopped.
            success : function(worker)
            {
            },
            error : function(request, status, reason_phrase)
            {
              //window.alert("Error stopping worker: " + reason_phrase);
            }
          });
        }

        var workerId = null;
        // Creating a table chunker worker
        $.ajax(
        {
          contentType : "application/json",
          data : $.toJSON({ type : "table-chunker", "mid" : "{{_id}}", "artifact" : "data-table", "generate-index" : "Index" }),
          processData : false,
          type : "POST",
          cache: false,
          url : "{{server-root}}" + "workers",
          async: false, // Much of the rest of the script relies on this table chunker, so doing this synchronously
          success : function(worker)
          {
            workerId = worker.id;
            // setup beforeunload handler to stop and delete worker when user leaves page
            $(window).bind('beforeunload', function(){
              stopWorker(worker); 
              deleteWorker(worker);
            });
          },
          error : function(request, status, reason_phrase)
          {
            window.alert("Error creating table-chunker worker: " + reason_phrase);
          },
        });

        // Grabbing metadata from the table chunker
        var data_table = null;
        $.ajax({
          url : "{{server-root}}" + "workers/" + workerId + "/table-chunker/metadata",
          contentType : "application/json",
          async: false, // Much of the rest of the script relies on this metadata, so dong this synchronously
          success: function(resp){
            data_table = resp;
          },
          error: function(request, status, reason_phrase){
            window.alert("Error getting metadata from table-chunker worker: " + reason_phrase);
          }
        });

        var index_column = data_table["column-count"] - 1;

        var simulation_count = canonical_variables ? canonical_variables.ranges[1][1] - canonical_variables.ranges[1][0] : 0;
        var cca_component = 0;

        var inputs = [];
        for(var i = 0; i != input_columns.length; ++i)
          inputs.push(data_table["column-names"][input_columns[i]]);

        var outputs = [];
        for(var i = 0; i != output_columns.length; ++i)
          outputs.push(data_table["column-names"][output_columns[i]]);

        var index = data_table["column-names"][index_column];

        var other_columns = [];
        var others = [];
        var column_count = data_table["column-count"];
        var all_column_indexes = [index_column].concat(input_columns).concat(output_columns);
        for(var i = 0; i != column_count; ++i) {
          if(all_column_indexes.indexOf(i) == -1) {
            other_columns.push(i);
            others.push(data_table["column-names"][i]);
          }
        }
        all_column_indexes = all_column_indexes.concat(other_columns);


        var scatterplot_data = [];
        for(var i = 0; i != simulation_count; ++i) {
          scatterplot_data.push([ canonical_variables.data[0][cca_component][i], canonical_variables.data[1][cca_component][i], i ]);
        }

        // Layout our resizable panels ...
        $("body").layout({
          south : {
            initClosed : true
            }
          });

        $("#content-pane").layout({
          north : {
            size : $("#content-pane").height() / 2,
            resizeWhileDragging : false
            }
          });

        $("#cca-pane").layout({
          center: {
            resizeWhileDragging : true
            },
          east : {
            size : ($("#content-pane").height() / 2) + 40,
            resizeWhileDragging : false,
            onresize : function() { cca_scatterplot.update({width: $("#scatterplot-pane").width(), height: $("#scatterplot-pane").height()}); }
            }
          });

        var simulation_pane_layout = $("#simulation-pane").layout({
          west : {
            size : $("#content-pane").height() / 2,
            resizeWhileDragging : true,
            initClosed : true
            },
          center: {
            resizeWhileDragging : true,
            onresize : function() { cca_simulation_table_instance.resizeGridCanvas(); }
            }
          });

        function selected_cca_component_changed(component)
        {
          $.ajax(
          {
            type : "POST",
            url : "{{server-root}}events/models/{{_id}}/select/component/" + component
          });

          bookmarker.updateState( {"cca-component" : component} );
        }

        function selected_variable_changed(type, index)
        {
          $.ajax(
          {
            type : "POST",
            url : "{{server-root}}events/models/{{_id}}/select/variable/" + type + "/" + index
          });

          bookmarker.updateState( {"variable-type" : type, "variable-index" : index} );
        }

        function selected_simulations_changed(indices)
        {
          // Logging every selected simulation gets slow, so just log the count instead.
          $.ajax(
          {
            type : "POST",
            url : "{{server-root}}events/models/{{_id}}/select/simulation/count/" + indices.length
          });
/*
          $.each(indices, function(index, value)
          {
            $.ajax(
            {
              type : "POST",
              url : "{{server-root}}events/models/{{_id}}/select/simulation/" + value
            });
          });
*/

          bookmarker.updateState( {"simulations" : indices} );
        }

        function variable_sort_order_changed(fieldIndex, direction, fieldName)
        {
          $.ajax(
          {
            type : "POST",
            url : "{{server-root}}events/models/{{_id}}/select/sort-order/" + fieldIndex + "/" + direction
          });

          bookmarker.updateState( {"sort-field" : fieldName, "sort-direction" : direction} );
        }

        // Updates the scatterplot when user selects a new cca component in the cca table
        function update_scatterplot_component(component)
        {
          for(var i = 0; i != simulation_count; ++i)
          {
            scatterplot_data[i][0] = canonical_variables.data[0][component][i];
            scatterplot_data[i][1] = canonical_variables.data[1][component][i];
          }

          cca_scatterplot.update({data: scatterplot_data});
        }

        // Updates the scatterplot when user selects a new input or output variable in the cca table
        function update_scatterplot_value(type, index)
        {
          var data_column;
          var value_label = null;

          if(type == "simulation") {
            data_column = index_column;
          }
          else if(type == "input") {
            data_column = input_columns[index];
          }
          else if(type == "output") {
            data_column = output_columns[index];
          }

          var queryParams = {
            "rows" : "0-" + data_table["row-count"],
            "columns" : index_column + "," + data_column,
          }

          req = $.ajax({
            url : "{{server-root}}" + "workers/" + workerId + "/table-chunker/chunk",
            contentType : "application/json",
            data: queryParams,
            processData : true,
            dataType: 'json',
            success: function(resp){
              var columns = resp["columns"];
              var row_indexes = resp["data"][columns.indexOf(index_column)];
              var row_data = resp["data"][columns.indexOf(data_column)];
              for (var i = 0; i < row_indexes.length; i++) {
                scatterplot_data[ row_indexes[i] ][2] = row_data[i];
              }
              value_label = resp["column-names"][columns.indexOf(data_column)];
              cca_scatterplot.update({
                value_label: value_label,
                data: scatterplot_data
                });
            },
            error: function(xhr, ajaxOptions, thrownError){
                //onError(fromPage, toPage, xhr, ajaxOptions, thrownError)
            }
          });

        }

        // Called when the grid initialized since now we can access data and restore state contained in the bookmark
        window.initial_update_scatterplot_value = function() {
          // Update the color coding of the scatterplot based on selected variable
          if("variable-type" in bookmark && "variable-index" in bookmark)
          {
            if(cca_scatterplot) {
              update_scatterplot_value(bookmark["variable-type"], bookmark["variable-index"]);
            }
          }
          // Updates the selected row(s) in the simulation table
          if("simulations" in bookmark)
          {
            if(cca_simulation_table_instance) {
              //cca_simulation_table_instance.update({simulation_selection: bookmark["simulations"]});
              cca_simulation_table_instance.update({unsorted_simulation_selection: bookmark["simulations"]});
            }
          }
          // Updates the sort order of columns in the simulation table
          if("sort-field" in bookmark && "sort-direction" in bookmark)
          {
            if(cca_simulation_table_instance) {
              cca_simulation_table_instance.update({
                sort_field: bookmark["sort-field"],
                sort_direction: bookmark["sort-direction"]});
            }
          }
        }

        // Setup the cca table ...
        if(inputs && outputs && statistics && x_structure_correlation && y_structure_correlation)
        {
          var cca_table = new cca_table_component({
            table: $("#cca-table"),
            inputs: inputs,
            outputs: outputs,
            statistics: statistics,
            x_structure_correlation: x_structure_correlation,
            y_structure_correlation: y_structure_correlation,
            add_component_callback: selected_cca_component_changed,
            add_variable_callback: selected_variable_changed,
            bookmarker: bookmarker,
            });
        }

        // Setup the simulation scatterplot ...
        var cca_scatterplot = new cca_scatterplot_component({
          container: "#scatterplot-canvas",
          data: scatterplot_data,
          width: $("#scatterplot-pane").width(),
          height: $("#scatterplot-pane").height(),
          add_simulation_callback: selected_simulations_changed,
          colorMapper: colorMapper,
          });

        var cca_simulation_table_instance = null;

        // Setup the simulation table ...
        if(inputs && outputs && data_table)
        {
          var cca_simulation_table_instance = new cca2_simulation_table({
            container: "#simulation-table-pane",
            index: index,
            inputs: inputs,
            outputs: outputs,
            others: others,
            variable_names: [index].concat(inputs).concat(outputs).concat(others),
            all_column_indexes: all_column_indexes,
            row_count: data_table["row-count"],
            max: data_table["column-max"],
            min: data_table["column-min"],
            index_column: index_column,
            input_columns: input_columns,
            output_columns: output_columns,
            other_columns: other_columns,
            add_simulation_callback: selected_simulations_changed,
            add_sort_order_callback: variable_sort_order_changed,
            colormap: bookmark["colormap"],
            colorMapper: colorMapper,
            }, "{{server-root}}", workerId);
          cca_simulation_table_instance.update({highlight: ["simulation", 0]});
        }

        // Setup linked selections ...
        if(cca_table && cca_scatterplot)
        {
          cca_table.update({add_variable_callback: update_scatterplot_value});
          cca_table.update({add_component_callback: update_scatterplot_component});
        }

        if(cca_table && cca_simulation_table_instance)
        {
          cca_table.update({add_variable_callback: function(type, index) { cca_simulation_table_instance.update({highlight: [type, index]}); }});
          cca_simulation_table_instance.update({add_variable_callback: function(type, index) { cca_table.update({highlight: [type, index]}); }});
        }

        if(cca_simulation_table_instance && cca_scatterplot)
        {
          // Selects scatterplot point when row in simulation table is clicked
          cca_simulation_table_instance.update({add_simulation_callback: function(indices) { cca_scatterplot.update({selection: indices}); }});
          // Selects row in simulation table when point in scatterplot is clicked
          cca_scatterplot.update({add_simulation_callback: function(indices) { cca_simulation_table_instance.update({simulation_selection: indices}); }});
        }

        /////////////////////////////////////////////////////////////////////////////////////
        // Restore some of the state contained in the URL query string.
        // Other state contained in the URL query string is restored in the 
        // window.initial_update_scatterplot_value function, since it needs to wait
        // until we have access to a table chunker and an initialized grid with data.

        // Updates selected cca component in the table and scatterplot, or selects the first one
        // if none have been selected.
        if("cca-component" in bookmark)
        {
          if(cca_table)
            cca_table.update({component: bookmark["cca-component"]});
          if(cca_scatterplot)
            update_scatterplot_component(bookmark["cca-component"]);
        }
        else
        {
          window.setTimeout(function() { cca_table.update({component: 0}); }, 2000);
        }

        if("simulations" in bookmark)
        {
          // Updates the selected point(s) in the scatterplot
          if(cca_scatterplot) {
            cca_scatterplot.update({selection: bookmark["simulations"]});
          }
        }

        if("variable-type" in bookmark && "variable-index" in bookmark)
        {
          // Update the selected variable in the cca table
          if(cca_table) {
            cca_table.update({highlight: [bookmark["variable-type"], bookmark["variable-index"]]});
          }
          // Update the selected variable (i.e., colored column) in the simulation table
          if(cca_simulation_table_instance) {
            cca_simulation_table_instance.update({highlight: [bookmark["variable-type"], bookmark["variable-index"]]});
          }
        }

        if("sort-cca-component" in bookmark && "sort-direction-cca-component" in bookmark)
        {
          // Update the sort order of the variables in the bookmarked cca component
          if(cca_table)
            cca_table.update({
              sort_component: bookmark["sort-cca-component"],
              sort_component_direction: bookmark["sort-direction-cca-component"],
            });
        }

      });

      ///////////////////////////////////////////////////////////////////////////////////////////
      // cca_table_component

      function cca_table_component(parameters)
      {
        this.table = parameters.table.empty();
        this.component_callbacks = [];
        this.variable_callbacks = [];

        function component_class(component)
        {
          return "cca" + (component + 1);
        }

        this.select_component = function(component)
        {
          d3.select(this.table.get(0)).selectAll(".selected-component")
            .classed("selected-component", false)
            ;

          d3.select(this.table.get(0)).selectAll("." + component_class(component))
            .classed("selected-component", true)
            ;

          d3.select(this.table.get(0)).selectAll("td.bar").filter(function() { return !d3.select(this).classed(component_class(component)); })
              .transition()
                .duration(500)
                .attr("width", 0)
            ;

          d3.select(this.table.get(0)).selectAll("td.bar").filter(function() { return !d3.select(this).classed(component_class(component)); })
            .selectAll("div")
              .transition()
                .duration(500)
                .style("width", "0px")
            ;

          d3.select(this.table.get(0)).selectAll("td.bar").filter(function() { return d3.select(this).classed(component_class(component)); })
              .transition()
                .duration(500)
                .attr("width", 100)
            ;

          function negative_bar_width(data, component)
          {
            return function(d, i)
            {
              var index = $(this).parent().parent().data("index");
              return data["data"][0][component][index] < 0 ? -100 * data["data"][0][component][index] + "px" : "0px";
            }
          }

          function positive_bar_width(data, component)
          {
            return function(d, i)
            {
              var index = $(this).parent().parent().data("index");
              return data["data"][0][component][index] > 0 ? 100 * data["data"][0][component][index] + "px" : "0px";
            }
          }

          d3.select(this.table.get(0)).selectAll("td.input.bar.negative." + component_class(component) + " div")
            .transition()
              .duration(500)
              .style("width", negative_bar_width(this.x_structure_correlation, component))
            ;

          d3.select(this.table.get(0)).selectAll("td.input.bar.positive." + component_class(component) + " div")
            .transition()
              .duration(500)
              .style("width", positive_bar_width(this.x_structure_correlation, component))
            ;

          d3.select(this.table.get(0)).selectAll("td.output.bar.negative." + component_class(component) + " div")
            .transition()
              .duration(500)
              .style("width", negative_bar_width(this.y_structure_correlation, component))
            ;

          d3.select(this.table.get(0)).selectAll("td.output.bar.positive." + component_class(component) + " div")
            .transition()
              .duration(500)
              .style("width", positive_bar_width(this.y_structure_correlation, component))
            ;
        }

        function click_component(context, component)
        {
          return function()
          {
            context.select_component(component);

            for(var i = 0; i != context.component_callbacks.length; ++i)
              context.component_callbacks[i](component);
          }
        }

        function sort_component(context, component)
        {
          return function()
          {
            var sort_order = 'descending';
            if( $(this).hasClass('icon-sort-descending') )
              sort_order = 'ascending';

           do_component_sort(component, sort_order);
          }
        }

        function do_component_sort(component, sort_order) {
          var table = $("table#cca-table");
          var sort_icon = $("th." + component_class(component) + " .sortCCAComponent", table)

          $("span.sortCCAComponent", table).removeClass("icon-sort-descending icon-sort-ascending").addClass("icon-sort-off");
          $(sort_icon).removeClass("icon-sort-off").addClass("icon-sort-" + sort_order);


          $("tbody tr.input", table).sort(sortFunction).appendTo(table);
          $("tbody tr.output", table).sort(sortFunction).appendTo(table);

          parameters.bookmarker.updateState( {"sort-cca-component" : component, "sort-direction-cca-component" : sort_order} );

          function sortFunction(a,b){
            var selector = "td.value:eq(" + component + ")";
            var value_a = $(selector, a).text();
            var value_b = $(selector, b).text();
            var aa = parseFloat(value_a.replace(/[^0-9.-]/g,''));
            if (isNaN(aa)) aa = 0;
            var bb = parseFloat(value_b.replace(/[^0-9.-]/g,''));
            if (isNaN(bb)) bb = 0;
            var result;
            if(sort_order == 'descending')
              result = Math.abs(bb)-Math.abs(aa);
            else
              result = Math.abs(aa)-Math.abs(bb);
            return result;
          }
        }

        function click_row(context, row, variable_type, variable_index)
        {
          return function()
          {
            context.table.find("tr").removeClass("selected-variable");
            row.addClass("selected-variable");

            for(var i = 0; i != context.variable_callbacks.length; ++i)
              context.variable_callbacks[i](variable_type, variable_index);
          }
        }

        var inputs = parameters.inputs;
        var outputs = parameters.outputs;
        var statistics = parameters.statistics;
        this.x_structure_correlation = parameters.x_structure_correlation;
        this.y_structure_correlation = parameters.y_structure_correlation;
        var cca_count = this.x_structure_correlation.ranges[0][1] - this.x_structure_correlation.ranges[0][0];

        var row = $("<tr>").appendTo(this.table);
        $("<th>").appendTo(row);
        for(var j = 0; j != cca_count; ++j)
        {
          $("<td class='bar'>").addClass(component_class(j)).appendTo(row);

          var th = $("<th class='label'><span class='selectCCAComponent'>CCA" + (j+1) + "</span><span class='sortCCAComponent icon-sort-off' /></th>").addClass(component_class(j))
          th.appendTo(row);
          $("span.selectCCAComponent", th).click(click_component(this, j));
          $("span.sortCCAComponent", th).click(sort_component(this, j));

          $("<td class='bar'>").addClass(component_class(j)).appendTo(row);
        }

        // Add r-squared statistic ...
        var row = $("<tr class='r2'>").appendTo(this.table);
        $("<th>R<sup>2</sup></th>").appendTo(row);
        for(var j = 0; j != cca_count; ++j)
        {
          $("<td class='bar'>").addClass(component_class(j)).appendTo(row);
          $("<td class='value'>").html(Number(statistics.data[0][j]).toFixed(3)).addClass(component_class(j)).appendTo(row);
          $("<td class='bar'>").addClass(component_class(j)).appendTo(row);
        }

        // Add p statistic ...
        var row = $("<tr class='p'>").appendTo(this.table);
        $("<th>P</th>").appendTo(row);
        for(var j = 0; j != cca_count; ++j)
        {
          $("<td class='bar'>").addClass(component_class(j)).appendTo(row);
          $("<td class='value'>").html(Number(statistics.data[1][j]).toFixed(3)).addClass(component_class(j)).appendTo(row);
          $("<td class='bar'>").addClass(component_class(j)).appendTo(row);
        }

        // Add input variables ...
        for(var i = 0; i != inputs.length; ++i)
        {
          var row = $("<tr class='input'>").addClass("index-" + i).data("index", i).appendTo(this.table);
          row.click(click_row(this, row, "input", i));

          $("<th>").html(inputs[i]).appendTo(row);

          for(var j = 0; j != cca_count; ++j)
          {
            $("<td class='input bar negative'><div></div></td>").addClass(component_class(j)).appendTo(row);
            $("<td class='input value'>").html(Number(this.x_structure_correlation.data[0][j][i]).toFixed(3)).addClass(component_class(j)).appendTo(row);
            $("<td class='input bar positive'><div></div></td>").addClass(component_class(j)).appendTo(row);
          }
        }

        // Add output variables ...
        for(var i = 0; i != outputs.length; ++i)
        {
          var row = $("<tr class='output'>").addClass("index-" + i).data("index", i).appendTo(this.table);
          row.click(click_row(this, row, "output", i));

          $("<th>").html(outputs[i]).appendTo(row);

          for(var j = 0; j != cca_count; ++j)
          {
            $("<td class='output bar negative'><div></div></td>").addClass(component_class(j)).appendTo(row);
            $("<td class='output value'>").html(Number(this.y_structure_correlation.data[0][j][i]).toFixed(3)).addClass(component_class(j)).appendTo(row);
            $("<td class='output bar positive'><div></div></td>").addClass(component_class(j)).appendTo(row);
          }
        }

        d3.select(this.table.get(0)).selectAll("td.bar")
          .attr("width", 0)
          ;
        d3.select(this.table.get(0)).selectAll("td.bar div")
          .style("width", "0px")
          ;

        this.update = function(parameters)
        {
          if(parameters.component != null)
          {
            this.select_component(parameters.component);
          }

          if(parameters.add_component_callback)
            this.component_callbacks.push(parameters.add_component_callback);

          if(parameters.add_variable_callback)
            this.variable_callbacks.push(parameters.add_variable_callback);

          if(parameters.highlight)
          {
            this.table.find("tr").removeClass("selected-variable");

            // Don't highlight anything if index column was selected
            if(parameters.highlight[0] != 'simulation')
              this.table.find("tr." + parameters.highlight[0] + ".index-" + parameters.highlight[1]).addClass("selected-variable");

            for(var i = 0; i != this.variable_callbacks.length; ++i)
              this.variable_callbacks[i](parameters.highlight[0], parameters.highlight[1]);
          }

          if(parameters.sort_component != null && parameters.sort_component_direction != null)
          {
            do_component_sort(parameters.sort_component, parameters.sort_component_direction);
          }
        }

        this.update(parameters);
      }

      //////////////////////////////////////////////////////////////////////////////////
      // cca_scatterplot_component

      function cca_scatterplot_component(parameters)
      {
        this.data = [];
        this.selection = [];
        this.start_drag = null;
        this.end_drag = null;
        this.color_mapper = parameters.colorMapper;
        this.simulation_callbacks = [];

        this.canvas = $(parameters.container);
        this.context = this.canvas.get(0).getContext("2d");

        this.data_canvas = $("<canvas>");
        this.data_context = this.data_canvas.get(0).getContext("2d");

        this.selection_canvas = $("<canvas>");
        this.selection_context = this.selection_canvas.get(0).getContext("2d");

        var self = this;

        this.canvas.mousedown(function(e)
        {
          self.start_drag = [e.layerX, e.layerY];
          self.end_drag = null;
        });

        this.canvas.mousemove(function(e)
        {
          if(self.start_drag) // Mouse is down ...
          {
            if(self.end_drag) // Already dragging ...
            {
              self.end_drag = [e.layerX, e.layerY];

              self.context.clearRect(0, 0, self.canvas.width(), self.canvas.height());
              self.context.drawImage(self.data_canvas.get(0), 0, 0);
              self.context.drawImage(self.selection_canvas.get(0), 0, 0);
              self.context.fillStyle = "rgba(255, 255, 0, 0.3)";
              self.context.fillRect(self.start_drag[0], self.start_drag[1], self.end_drag[0] - self.start_drag[0], self.end_drag[1] - self.start_drag[1]);
              self.context.strokeStyle = "rgb(255, 255, 0)";
              self.context.lineWidth = 2.0;
              self.context.strokeRect(self.start_drag[0], self.start_drag[1], self.end_drag[0] - self.start_drag[0], self.end_drag[1] - self.start_drag[1]);
            }
            else
            {
              if(Math.abs(e.layerX - self.start_drag[0]) > 3 || Math.abs(e.layerY - self.start_drag[1]) > 3) // Start dragging ...
              {
                self.end_drag = [e.layerX, e.layerY];
              }
            }
          }
        });

        this.canvas.mouseup(function(e)
        {
          var selection = [];

          if(self.start_drag && self.end_drag) // Rubber-band selection ...
          {
            var x1 = ((Math.min(self.start_drag[0], self.end_drag[0]) - self.canvas.width() / 2) / self.scale) + self.x_center;
            var y1 = ((Math.max(self.start_drag[1], self.end_drag[1]) - self.canvas.height() / 2) / -self.scale) + self.y_center;
            var x2 = ((Math.max(self.start_drag[0], self.end_drag[0]) - self.canvas.width() / 2) / self.scale) + self.x_center;
            var y2 = ((Math.min(self.start_drag[1], self.end_drag[1]) - self.canvas.height() / 2) / -self.scale) + self.y_center;
          }
          else // Pick selection ...
          {
            var range = 3;
            var x1 = (((e.layerX - range) - self.canvas.width() / 2) / self.scale) + self.x_center;
            var y1 = (((e.layerY + range) - self.canvas.height() / 2) / -self.scale) + self.y_center;
            var x2 = (((e.layerX + range) - self.canvas.width() / 2) / self.scale) + self.x_center;
            var y2 = (((e.layerY - range) - self.canvas.height() / 2) / -self.scale) + self.y_center;
          }

          self.start_drag = null;
          self.end_drag = null;

          for(var i in self.data)
          {
            if(x1 <= self.data[i][0] && self.data[i][0] <= x2 && y1 <= self.data[i][1] && self.data[i][1] <= y2)
            {
              selection.push(i);
            }
          }

          self.update({selection:selection});

          for(var i in self.simulation_callbacks)
            self.simulation_callbacks[i](selection);
        });

        this.update = function(parameters)
        {
          console.info(parameters);

          if(parameters.data)
          {
            this.data = parameters.data;

            this.x_min = d3.min(this.data, function(d) { return d[0]; });
            this.x_max = d3.max(this.data, function(d) { return d[0]; });
            this.y_min = d3.min(this.data, function(d) { return d[1]; });
            this.y_max = d3.max(this.data, function(d) { return d[1]; });

            this.x_center = (this.x_min + this.x_max) / 2;
            this.y_center = (this.y_min + this.y_max) / 2;

            var v_min = d3.min(this.data, function(d) { return d[2]; });
            var v_max = d3.max(this.data, function(d) { return d[2]; });
            this.color = this.color_mapper.createSelectedColorMap(v_min, v_max);
          }

          if(parameters.color)
          {
            var v_min = d3.min(this.data, function(d) { return d[2]; });
            var v_max = d3.max(this.data, function(d) { return d[2]; });
            this.color = this.color_mapper.createSelectedColorMap(v_min, v_max);
          }

          if(parameters.width)
          {
            this.canvas.attr("width", parameters.width).css("width", parameters.width);
            this.data_canvas.attr("width", parameters.width);
            this.selection_canvas.attr("width", parameters.width);
          }

          if(parameters.height)
          {
            this.canvas.attr("height", parameters.height).css("height", parameters.height);
            this.data_canvas.attr("height", parameters.height);
            this.selection_canvas.attr("height", parameters.height);
          }

          if(parameters.data || parameters.width || parameters.height)
          {
            var width = this.canvas.attr("width");
            var height = this.canvas.attr("height");
            this.scale = 0.4 * Math.min(width / (this.x_max - this.x_center), width / (this.x_center - this.x_min), height / (this.y_max - this.y_center), height / (this.y_center - this.y_min));
          }

          if(parameters.add_simulation_callback)
          {
            this.simulation_callbacks.push(parameters.add_simulation_callback);
          }

          if(parameters.selection)
          {
            this.selection = parameters.selection;
          }

          if(parameters.color || parameters.data || parameters.width || parameters.height || parameters.selection)
          {
            console.info("render selection");
            var width = this.selection_canvas.attr("width");
            var height = this.selection_canvas.attr("height");

            this.selection_context.setTransform(1, 0, 0, 1, 0, 0);
            this.selection_context.clearRect(0, 0, width, height);
            if(this.data)
            {
              this.selection_context.translate(width / 2, height / 2);
              this.selection_context.scale(this.scale, -this.scale);
              this.selection_context.translate(-this.x_center, -this.y_center);

              // Draw selected points ...
              var radius = 5 / this.scale;
              var twopi = Math.PI * 2;
              this.selection_context.strokeStyle = "black";
              this.selection_context.lineWidth = 1 / this.scale;
              for(var i in this.selection)
              {
                var index = this.selection[i];
                this.selection_context.fillStyle = this.color(this.data[index][2]);
                this.selection_context.beginPath();
                this.selection_context.arc(this.data[index][0], this.data[index][1], radius, 0, twopi);
                this.selection_context.fill();
                this.selection_context.stroke();
              }
            }
          }

          if(parameters.color || parameters.data || parameters.width || parameters.height)
          {
            console.info("render data");
            this.data_context.setTransform(1, 0, 0, 1, 0, 0);
            this.data_context.clearRect(0, 0, this.canvas.width(), this.canvas.height());

            // Draw labels ...
            this.data_context.font = "10pt Arial";
            this.data_context.textAlign = "center";
            this.data_context.fillStyle = "gray";

            this.data_context.save();
            this.data_context.textBaseline = "alphabetic";
            this.data_context.translate(this.canvas.width() / 2, this.canvas.height() - 5);
            this.data_context.fillText("Input Metavariable", 0, 0);
            this.data_context.restore();

            this.data_context.save();
            this.data_context.textBaseline = "top";
            this.data_context.translate(5, this.canvas.height() / 2);
            this.data_context.rotate(-Math.PI / 2);
            this.data_context.fillText("Output Metavariable", 0, 0);
            this.data_context.restore();

            if(this.data)
            {
              this.data_context.translate(this.canvas.width() / 2, this.canvas.height() / 2);
              this.data_context.scale(this.scale, -this.scale);
              this.data_context.translate(-this.x_center, -this.y_center);

              // Draw points using circles ...
              if(this.data.length < 100000)
              {
                var radius = 2 / this.scale;
                var twopi = Math.PI * 2;
                this.data_context.stokeStyle = "black";
                this.data_context.lineWidth = 1 / this.scale;
                for(var i in this.data)
                {
                  this.data_context.fillStyle = this.color(this.data[i][2]);
                  this.data_context.beginPath();
                  this.data_context.arc(this.data[i][0], this.data[i][1], radius, 0, twopi);
                  this.data_context.fill();
                  this.data_context.stroke();
                }
              }
              // Draw points using rectangles ...
              else
              {
                var size = 2 / this.scale;
                for(var i in this.data)
                {
                  this.data_context.fillStyle = this.color(this.data[i][2]);
                  this.data_context.fillRect(this.data[i][0], this.data[i][1], size, size);
                }
              }
            }
          }

          if(parameters.color || parameters.data || parameters.width || parameters.height || parameters.selection)
          {
            console.info("render");
            this.context.clearRect(0, 0, this.canvas.width(), this.canvas.height());
            this.context.drawImage(this.data_canvas.get(0), 0, 0);
            this.context.drawImage(this.selection_canvas.get(0), 0, 0);
          }
        }

        this.update(parameters);
      }

    </script>
  </body>
</html>
